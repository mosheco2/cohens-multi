<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××™×œ×× ×™×” - ×××©×§ × ×™×”×•×œ ××ª×§×“×</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #F84779; --secondary: #15C4C1; --dark: #2B1E4A; --light: #FFF8EA; --bg: #f8f9fa; }
        body { font-family: "Varela Round", sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--dark); direction: rtl; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; }

        /* --- ×¢×™×¦×•×‘ ×˜××‘×™× --- */
        .tabs-nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 12px 24px; border: none; background: transparent; font-size: 1.1rem; font-weight: bold; color: #666; cursor: pointer; border-radius: 12px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ×¢×™×¦×•×‘ ××§×•×¨×™ (×¡×˜×˜×™×¡×˜×™×§×•×ª ×•×—×“×¨×™×) --- */
        .stats-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #fff, #f8f7ff); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { margin: 0 0 10px; font-size: 1rem; color: #666; }
        .stat-number { font-size: 2.2rem; font-weight: 900; color: var(--primary); margin: 0; }
        .stat-sub { font-size: 0.9rem; color: #888; margin-top: 5px; }

        .filters-section { background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #eee; display: flex; gap: 15px; flex-wrap: wrap; align-items: end; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-family: inherit; font-size: 1rem; }

        .room-card { background: #fff; border: 1px solid #eee; border-radius: 16px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; transition: 0.2s; position: relative; overflow: hidden; }
        .room-card.active { border-left: 5px solid var(--secondary); background: #f0fffe; }
        .room-card.ended { border-left: 5px solid #ccc; background: #f9f9f9; opacity: 0.8; }
        .room-info h4 { margin: 0 0 5px; font-size: 1.3rem; }
        .room-meta { font-size: 0.95rem; color: #666; margin: 4px 0; display: flex; gap: 15px; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 5px; }

        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-danger { background: #ffebeb; color: #d32f2f; border: 1px solid #ffcdd2; }
        .btn-info { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .btn-primary { background: var(--primary); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .players-list { width: 100%; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; display: none; }
        .team-group { margin-bottom: 10px; }
        .team-name { font-weight: bold; margin-bottom: 5px; }
        .player-chip { display: inline-block; background: #eee; padding: 4px 12px; border-radius: 20px; margin: 2px; font-size: 0.9rem; }

        /* --- ×¢×™×¦×•×‘ ××—×•×œ×œ ××•×ª×’ (×—×“×©) --- */
        .brand-section { background: #F8F7FF; padding: 20px; border-radius: 16px; }
        .brand-preview-box { border: 1px solid #eee; padding: 20px; border-radius: 16px; text-align: center; background: var(--preview-bg, #FFF8EA); margin-top: 20px; }
        .brand-logo-prev { max-height: 100px; margin-bottom: 10px; }
        .btn-wa { background: #25D366; color: white; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }

        @media (max-width: 768px) {
            .room-card { flex-direction: column; align-items: flex-start; }
            .room-actions { width: 100%; display: flex; gap: 10px; margin-top: 15px; }
            .room-actions .btn { flex: 1; }
            .filters-section { flex-direction: column; }
            .filter-group { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ ××™×œ×× ×™×” - ××¨×›×– ×©×œ×™×˜×”</h1>

        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('rooms')">ğŸ“Š × ×™×”×•×œ ×—×“×¨×™× ×•×¡×˜×˜×™×¡×˜×™×§×”</button>
            <button class="tab-btn" onclick="switchTab('branding')">âœ¨ ××—×•×œ×œ ××•×ª×’</button>
        </div>

        <div id="tab-rooms" class="tab-content active">
            <div class="stats-header">
                <div class="stat-card">
                    <h3>××©×—×§×™× ×¤×¢×™×œ×™× ×›×¨×’×¢</h3>
                    <div class="stat-number" id="statActiveGames">-</div>
                </div>
                <div class="stat-card">
                    <h3>××©×ª××©×™× ××—×•×‘×¨×™× (Socket)</h3>
                    <div class="stat-number" id="statConnectedUsers">-</div>
                </div>
                <div class="stat-card">
                    <h3>×›×ª×•×‘×•×ª IP ×™×™×—×•×“×™×•×ª</h3>
                    <div class="stat-number" id="statUniqueIps">-</div>
                </div>
            </div>

            <div class="filters-section">
                <div class="filter-group">
                    <label>××ª××¨×™×š</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="filter-group">
                    <label>×¢×“ ×ª××¨×™×š</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="filter-group" style="flex: 0 0 auto;">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="fetchHistory()">ğŸ“… ×¦×¤×” ×‘×”×™×¡×˜×•×¨×™×”</button>
                </div>
                <div class="filter-group" style="flex: 0 0 auto; margin-right: auto;">
                    <label>&nbsp;</label>
                    <button class="btn btn-info" onclick="fetchAdminStats()">ğŸ”„ ×¨×¢× ×Ÿ ×‘×–××Ÿ ×××ª</button>
                </div>
            </div>

            <h2 style="margin-bottom: 20px;">×¨×©×™××ª ×—×“×¨×™×</h2>
            <div id="rooms-list">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        </div>

        <div id="tab-branding" class="tab-content">
            <div class="brand-section">
                <h2>××—×•×œ×œ ××•×ª×’ (Branding Gen)</h2>
                <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight:bold;">×›×•×ª×¨×ª ×”××•×ª×’</label>
                        <input type="text" id="brandTitle" placeholder="×œ×“×•×’××”: ×‘× ×§ ×”×¤×•×¢×œ×™×">
                    </div>
                    <div>
                        <label style="font-weight:bold;">×¡×œ×•×’×Ÿ</label>
                        <input type="text" id="brandSlogan" placeholder="×œ×”×™×•×ª ×¨××©×•×Ÿ ×–×” ××—×™×™×‘">
                    </div>
                    <div>
                        <label style="font-weight:bold;">×›×ª×•×‘×ª ×œ×•×’×•</label>
                        <input type="text" id="brandLogo" placeholder="https://example.com/logo.png">
                    </div>
                    <div>
                        <label style="font-weight:bold;">×¦×‘×¢ ×¨×§×¢ (×”×§×¡×“×¦×™××œ×™)</label>
                        <input type="color" id="brandColor" value="#FFF8EA" style="height:50px; padding:5px; width:100%;">
                    </div>
                </div>
                
                <div class="brand-preview-box" id="brandPreview">
                    <img id="brandLogoPrev" class="brand-logo-prev" src="" style="display:none; margin: auto;">
                    <h3 id="brandTitlePrev" style="margin:10px 0 5px;">×›×•×ª×¨×ª ×”××•×ª×’</h3>
                    <p id="brandSloganPrev" style="margin:0; color:#666;">×¡×œ×•×’×Ÿ ×”××•×ª×’</p>
                </div>

                <label style="margin-top:20px; font-weight:bold; display:block;">×§×™×©×•×¨ ×××•×ª×’ ×œ×™×¦×™×¨×ª ××©×—×§</label>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <input type="text" id="generatedLink" readonly style="margin-bottom:0; flex: 1; min-width: 250px;">
                    <a id="shareWaBtn" class="btn btn-wa" href="#" target="_blank" style="display:none;">
                        <span style="font-size: 1.2rem;">ğŸ“±</span> ×©×œ×— ×‘×•×•×¦××¤
                    </a>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_ADMIN_STATS = "/admin/stats?code=ONEBTN"; // ×•×•×“× ×©×”×§×•×“ ×ª×•×× ×œ×©×¨×ª
        const API_ADMIN_HISTORY = "/admin/history?code=ONEBTN";

        // --- ×œ×•×’×™×§×ª ×˜××‘×™× ---
        function switchTab(tabId) {
            // ×”×¡×¨×ª ×§×œ××¡ active ××›×œ ×”×›×¤×ª×•×¨×™× ×•×”×ª×•×›×Ÿ
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ×”×•×¡×¤×ª active ×œ×˜××‘ ×”× ×‘×—×¨
            document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // --- ×œ×•×’×™×§×ª × ×™×”×•×œ ×—×“×¨×™× (××§×•×¨×™) ---
        async function fetchAdminStats() {
            try {
                const res = await fetch(API_ADMIN_STATS);
                const data = await res.json();
                
                document.getElementById('statActiveGames').innerText = data.stats.activeGamesCount;
                document.getElementById('statConnectedUsers').innerText = data.stats.connectedSockets;
                document.getElementById('statUniqueIps').innerText = data.stats.uniqueIps;
                
                renderRooms(data.activeGames, true);
            } catch(e) {
                console.error(e);
                document.getElementById('rooms-list').innerHTML = '<p style="color:red">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</p>';
            }
        }

        async function fetchHistory() {
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;
            if(!start || !end) return alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×");

            try {
                document.getElementById('rooms-list').innerHTML = '×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...';
                const res = await fetch(`${API_ADMIN_HISTORY}&startDate=${start}&endDate=${end}`);
                const data = await res.json();
                renderRooms(data.games, false);
            } catch(e) {
                console.error(e);
                document.getElementById('rooms-list').innerHTML = '<p style="color:red">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”</p>';
            }
        }

        function formatIP(ip) {
            return ip ? ip.replace('::ffff:', '') : '×œ× ×™×“×•×¢';
        }

        function renderRooms(games, isActiveView) {
            const container = document.getElementById('rooms-list');
            if(!games || games.length === 0) {
                container.innerHTML = '<p>×œ× × ××¦××• ××©×—×§×™×.</p>';
                return;
            }

            let html = '';
            // ××™×•×Ÿ: ×¤×¢×™×œ×™× ×§×•×“×, ×•××– ×œ×¤×™ ×–××Ÿ ×™×¦×™×¨×” ×™×•×¨×“
            games.sort((a, b) => {
                if (a.isActive !== b.isActive) return b.isActive - a.isActive;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            games.forEach(g => {
                const statusClass = g.isActive ? 'active' : 'ended';
                const statusText = g.isActive ? 'ğŸŸ¢ ×¤×¢×™×œ ×›×¨×’×¢' : 'âš« ×”×¡×ª×™×™×';
                const createdTime = new Date(g.createdAt).toLocaleString('he-IL');
                const duration = g.endedAt ? Math.round((new Date(g.endedAt) - new Date(g.createdAt))/60000) + ' ×“×§\'' : '××ª× ×”×œ...';

                let playersHtml = '';
                if(g.teams) {
                    Object.values(g.teams).forEach(t => {
                        playersHtml += `<div class="team-group"><div class="team-name">${t.name} (${t.score} × ×§'):</div>`;
                        t.players.forEach(p => {
                            playersHtml += `<span class="player-chip">${p.name || '×œ× ×™×“×•×¢'}</span>`;
                        });
                        playersHtml += `</div>`;
                    });
                }

                html += `
                <div class="room-card ${statusClass}" id="room-${g.code}">
                    <div class="room-info">
                        <h4>${g.gameTitle || '×œ×œ× ×›×•×ª×¨×ª'} <span style="font-size:0.8em; opacity:0.7">(${g.code})</span></h4>
                        <div class="room-meta">
                            <span class="meta-item">ğŸ‘¤ ×× ×”×œ: <strong>${g.hostName}</strong></span>
                            <span class="meta-item">ğŸŒ IP: <strong>${formatIP(g.hostIp)}</strong></span>
                        </div>
                        <div class="room-meta">
                            <span class="meta-item">ğŸ“… × ×•×¦×¨: ${createdTime}</span>
                            <span class="meta-item">â±ï¸ ××©×š: ${duration}</span>
                            <span class="meta-item">${statusText}</span>
                        </div>
                         <div class="room-meta">
                            <span class="meta-item">ğŸ‘¥ ×©×—×§× ×™×: ${g.totalPlayers || 0}</span>
                            <span class="meta-item">ğŸ³ï¸ ×§×‘×•×¦×•×ª: ${g.totalTeams || 0}</span>
                        </div>
                    </div>
                    <div class="room-actions">
                        <button class="btn btn-info" onclick="togglePlayers('${g.code}')">ğŸ‘¥ ×”×¦×’ ×©×—×§× ×™×</button>
                        ${g.isActive ? `<button class="btn btn-danger" onclick="closeRoom('${g.code}')">ğŸ›‘ ×¡×’×•×¨ ×—×“×¨</button>` : ''}
                        <a href="/host.html?code=${g.code}" target="_blank" class="btn" style="background:#eee; text-decoration:none;">ğŸ”— ×›× ×™×¡×” ×›×× ×”×œ</a>
                    </div>
                    <div id="players-${g.code}" class="players-list">
                        ${playersHtml || '××™×Ÿ × ×ª×•× ×™ ×©×—×§× ×™×'}
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function togglePlayers(code) {
            const el = document.getElementById(`players-${code}`);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        async function closeRoom(code) {
            if(!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¡×’×•×¨ ××ª ×—×“×¨ ${code}? ×›×œ ×”×©×—×§× ×™× ×™× ×•×ª×§×•.`)) return;
            try {
                // × ×“×¨×© × ×ª×™×‘ ×‘×©×¨×ª ×œ×¡×’×™×¨×ª ×—×“×¨ (×œ× ××•××© ×‘×©×¨×ª ×”××§×•×¨×™, ××š ×”×›×¤×ª×•×¨ ×”×™×” ×§×™×™×)
                alert(`×‘×§×©×” ×œ×¡×’×™×¨×ª ×—×“×¨ ${code} × ×©×œ×—×” (× ×“×¨×© ××™××•×© ×‘×©×¨×ª)`);
                // fetch('/admin/close-room', { method: 'POST', body: JSON.stringify({code}) ... });
                fetchAdminStats(); // ×¨×¢× ×•×Ÿ ×œ××—×¨ ×¤×¢×•×œ×”
            } catch(e) { alert('×©×’×™××” ×‘×¡×’×™×¨×ª ×”×—×“×¨'); }
        }

        // --- ×œ×•×’×™×§×ª ××—×•×œ×œ ××•×ª×’ (×”×—×“×©) ---
        function generateLink() {
            const title = encodeURIComponent(document.getElementById('brandTitle').value.trim());
            const slogan = encodeURIComponent(document.getElementById('brandSlogan').value.trim());
            const logo = encodeURIComponent(document.getElementById('brandLogo').value.trim());
            const color = document.getElementById('brandColor').value.substring(1);
            
            let link = `${window.location.origin}/host.html?`;
            if(title) link += `title=${title}&`;
            if(slogan) link += `slogan=${slogan}&`;
            if(logo) link += `logo=${logo}&`;
            if(color) link += `color=${color}`;

            document.getElementById('generatedLink').value = link;
            
            if(link.includes('=')) {
                const waText = `×”×™×™, ×™×¦×¨×ª×™ ×œ×™× ×§ ×œ××©×—×§ ×××•×ª×’!\n×›× ×¡×• ××›××Ÿ:\n${link}`;
                document.getElementById('shareWaBtn').href = `https://wa.me/?text=${encodeURIComponent(waText)}`;
                document.getElementById('shareWaBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('shareWaBtn').style.display = 'none';
            }

            // ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ××§×“×™××”
            document.getElementById('brandPreview').style.setProperty('--preview-bg', '#' + color);
            const titleVal = document.getElementById('brandTitle').value.trim();
            document.getElementById('brandTitlePrev').textContent = titleVal || '×›×•×ª×¨×ª ×”××•×ª×’';
            const sloganVal = document.getElementById('brandSlogan').value.trim();
            document.getElementById('brandSloganPrev').textContent = sloganVal || '';
            const logoVal = document.getElementById('brandLogo').value.trim();
            const logoImg = document.getElementById('brandLogoPrev');
            if(logoVal) { logoImg.src = logoVal; logoImg.style.display = 'block'; }
            else { logoImg.style.display = 'none'; }
        }

        ['brandTitle', 'brandSlogan', 'brandLogo', 'brandColor'].forEach(id => {
            document.getElementById(id).addEventListener('input', generateLink);
        });

        // ××ª×—×•×œ: ×”×’×“×¨×ª ×ª××¨×™×›×™× ×‘×¨×™×¨×ª ××—×“×œ ×•×˜×¢×™× ×ª × ×ª×•× ×™×
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterStartDate').value = today;
        document.getElementById('filterEndDate').value = today;
        fetchAdminStats();
    </script>
</body>
</html>
