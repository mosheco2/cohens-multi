<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - × ×™×”×•×œ ××©×—×§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  <style>
    :root { font-size: 16px; --bg-color: #FFF8EA; }
    * { box-sizing: border-box; font-family: "Varela Round", sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg-color); color: #2B1E4A; min-height: 100vh; }
    .app { max-width: 1024px; margin: 0 auto; padding: 20px 14px 80px; }
    .card { background: #FFFFFF; border-radius: 26px; padding: 24px 20px; margin-bottom: 16px; box-shadow: 0 18px 40px rgba(0,0,0,0.06); }
    h1,h2,h3 { margin-top:0; color:#2B1E4A; }
    .btn { padding: 14px 24px; border-radius: 18px; border: none; cursor: pointer; font-weight: 700; font-size: 1rem; transition: 0.2s; width:100%; margin-top:8px; }
    .btn-primary { background: linear-gradient(135deg, #F84779, #FF8566); color: white; }
    .btn-success { background: linear-gradient(135deg, #15C4C1, #42E695); color: white; }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
    .btn-whatsapp { background: #25D366; color: white; }
    .btn-ghost { background: transparent; border: 2px solid rgba(107, 97, 143, 0.3); color: #6B618F; width:auto; padding:8px 16px; }
    .hidden { display: none !important; }
    input, select { width: 100%; padding: 12px; border-radius: 14px; border: 2px solid rgba(43,30,74,0.15); background: #FFFDF7; font-size: 1rem; margin-bottom:8px; }
    
    /* Team Input */
    .team-input-row { display: flex; gap: 10px; margin-bottom: 10px; }
    
    /* ××•×“×œ */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-box { background: #fff; width: 85%; max-width: 400px; border-radius: 28px; padding: 30px; text-align: center; }

    /* ×›×¤×ª×•×¨ ×ª××™×›×” */
    #support-wa-btn { position: fixed; bottom: 24px; right: 24px; z-index: 2000; background: #25D366; color: white; border-radius: 50px; padding: 12px 20px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; font-family: "Varela Round", sans-serif; }

    /* ×ª×¦×•×’×ª ×× ×”×œ ×©×—×§×Ÿ */
    #hostPlayerGameCard { border: none; background: none; padding: 0; box-shadow: none; }
    .nested-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .top-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
    .top-tabs button { flex: 1; padding: 10px; border: none; background: rgba(255,255,255,0.5); border-radius: 12px; cursor: pointer; }
    .top-tabs button.active { background: #F8F7FF; color: #F84779; font-weight: bold; border: 1px solid #F84779; }

    /* ×¤×× ×œ ×¦×£ */
    #adminFab { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #2B1E4A; color: #FFD76F; padding: 12px 24px; border-radius: 50px; font-weight: 700; z-index: 100; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    #adminFloatingPanel { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: #FFFFFF; border-radius: 24px; padding: 24px; z-index: 99; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div class="app">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
         <div style="display:flex; align-items:center; gap:10px;">
             <img id="host-logo" src="logo.png" style="height:50px; display:none;"> 
             <h1 style="margin:0; font-size:1.5rem;">× ×™×”×•×œ ××©×—×§</h1>
         </div>
         <div style="display:flex; gap:5px;">
             <button class="btn-ghost" onclick="location.href='instructions.html'">?</button>
             <button class="btn-ghost" onclick="location.href='home.html'">×‘×™×ª</button>
         </div>
      </div>

      <div class="top-tabs">
          <button id="tabHost" class="active">ğŸ‘‘ × ×™×”×•×œ</button>
          <button id="tabPlayer">ğŸ® ×× ×™ ×›×©×—×§×Ÿ</button>
      </div>

      <div id="hostMode">
          <div class="card" id="createGameCard">
              <h3>×”×’×“×¨×ª ××©×—×§ ×—×“×©</h3>
              <input id="hostName" type="text" placeholder="×©× ×”×× ×”×œ">
              
              <h4>×§×‘×•×¦×•×ª</h4>
              <div id="teamsContainer">
                  <div class="team-input-row"><input class="team-name" value="××›×™×¨×•×ª" placeholder="×©× ×§×‘×•×¦×” 1"></div>
                  <div class="team-input-row"><input class="team-name" value="×©×™×•×•×§" placeholder="×©× ×§×‘×•×¦×” 2"></div>
              </div>
              <button class="btn-ghost" onclick="addTeamInput()">+ ×”×•×¡×£ ×§×‘×•×¦×”</button>

              <button id="createGameBtn" class="btn btn-primary" style="margin-top:20px;">×¦×•×¨ ××©×—×§</button>
          </div>

          <div id="activeGameControls" class="hidden">
              <div class="card">
                  <h3>×§×•×“ ××©×—×§: <span id="gameCodeDisplay" style="color:#F84779;"></span></h3>
                  <div style="margin-top:10px;">
                      <select id="inviteTeamSelect"><option>×‘×—×¨ ×§×‘×•×¦×” ×œ×”×–×× ×”</option></select>
                      <button id="whatsappInviteBtn" class="btn btn-whatsapp">×”×–××Ÿ ×‘×•×•×¦××¤</button>
                  </div>
                  <button class="btn btn-danger" style="width:100%; margin-top:15px;" onclick="endGame()">ğŸ›‘ ×¡×’×•×¨ ××©×—×§</button>
              </div>
              
              <div class="card">
                  <h3>×§×‘×•×¦×•×ª ×•×§×™×©×•×¨×™×</h3>
                  <div id="teamsShareList"></div>
              </div>

              <div class="card">
                  <h3>× ×™×”×•×œ ×¡×™×‘×•×‘</h3>
                  <div style="text-align:center; margin-bottom:15px;">
                      <div id="roundStatus">×××ª×™×Ÿ...</div>
                      <div id="roundTimer" style="font-size:2rem; font-weight:bold; color:#F84779;">--:--</div>
                  </div>
                  <select id="roundTeamSelect"><option>×‘×—×¨ ×§×‘×•×¦×”</option></select>
                  <select id="explainerSelect" style="margin-top:5px;"><option>××¡×‘×™×¨ (××•×˜×•××˜×™)</option></select>
                  <button id="startRoundBtn" class="btn btn-success" style="width:100%; margin-top:10px;">â–¶ ×”×ª×—×œ ×¡×™×‘×•×‘</button>
                  <button id="stopRoundBtn" class="btn btn-danger" style="width:100%; margin-top:5px;" disabled>â¹ ×¡×™×™×</button>
              </div>

              <div class="card">
                  <h3>× ×™×§×•×“</h3>
                  <div id="scoreboard"></div>
                  <hr style="margin:10px 0; border-top:1px solid #eee;">
                  <h3>×©×—×§× ×™×</h3>
                  <div id="playersByTeam"></div>
              </div>
          </div>
      </div>

      <div id="playerMode" class="hidden">
          <div class="card" id="hostPlayerJoinCard">
             <h3>×”×¦×˜×¨×¤×•×ª ×›×©×—×§×Ÿ</h3>
             <input id="hostPlayerName" placeholder="×©× ×©×—×§×Ÿ">
             <select id="hostPlayerTeamSelect"><option>×‘×—×¨ ×§×‘×•×¦×”</option></select>
             <button id="openPlayerViewBtn" class="btn btn-primary">×”×¦×˜×¨×£</button>
          </div>

          <div id="hostPlayerGameCard" class="hidden">
              <div class="nested-card">
                 <div style="margin-bottom:10px;">
                     <strong>×”×§×‘×•×¦×” ×©×œ×™:</strong> <span id="hostPlayerTeamName"></span>
                 </div>
                 <div id="hostRoundStatusPlayer" style="margin-bottom:10px;"></div>
                 <div id="hostPlayerBigTimer" style="font-size:2rem; text-align:center; font-weight:bold; color:#F84779;">--:--</div>
                 
                 <div id="hostPresenterSection" class="hidden" style="text-align:center; margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                    <h2 id="hostPresenterWord" style="font-size:2.5rem; margin:5px 0;">××™×œ×”</h2>
                    <div style="display:flex; gap:10px;">
                        <button id="hostBtnSkip" class="btn btn-primary">×“×œ×’</button>
                        <button id="hostBtnCorrect" class="btn btn-success">× ×›×•×Ÿ!</button>
                    </div>
                 </div>
              </div>
          </div>
      </div>
  </div>

  <div id="adminFab" class="hidden">ğŸ‘‘ × ×™×”×•×œ</div>
  <div id="adminFloatingPanel" class="hidden">
      <h3>× ×™×”×•×œ ××”×™×¨</h3>
      <select id="floatTeamSelect"></select>
      <select id="floatExplainerSelect" style="margin-top:5px;"><option value="">××•×˜×•××˜×™</option></select>
      <input id="floatSeconds" type="number" value="60" style="margin-top:5px; text-align:center;">
      <button id="floatStartBtn" class="btn btn-success" style="width:100%; margin-top:10px;">×”×ª×—×œ</button>
      <button id="floatStopBtn" class="btn btn-danger" style="width:100%; margin-top:5px;">×¡×™×™×</button>
      <button onclick="document.getElementById('adminFloatingPanel').classList.add('hidden'); document.getElementById('adminFab').classList.remove('hidden');" class="btn-ghost" style="width:100%; margin-top:5px;">×¡×’×•×¨</button>
  </div>

  <div class="modal-overlay" id="customModal">
      <div class="modal-box">
          <h2 id="modalTitle"></h2>
          <div id="modalContent"></div>
          <button class="btn btn-primary" onclick="document.getElementById('customModal').classList.remove('active')">×¡×’×•×¨</button>
      </div>
  </div>

  <div id="support-wa-btn" onclick="openSupport()">ğŸ’¬ ×ª××™×›×”</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentGameCode = null;
    let lastGameState = null;
    let isHostAlsoPlayer = false;
    let hostPlayerClientId = null;
    let hostIsCurrentExplainer = false;

    const tabHost = document.getElementById("tabHost");
    const tabPlayer = document.getElementById("tabPlayer");
    const hostMode = document.getElementById("hostMode");
    const playerMode = document.getElementById("playerMode");
    const adminFab = document.getElementById("adminFab");
    const adminFloatingPanel = document.getElementById("adminFloatingPanel");

    // Branding
    const urlParams = new URLSearchParams(window.location.search);
    const branding = {
        name: urlParams.get('brand'),
        logo: urlParams.get('logo'),
        color: urlParams.get('color')
    };
    if(branding.color) document.body.style.setProperty('--bg-color', '#' + branding.color);
    if(branding.logo) {
        const img = document.getElementById('host-logo');
        img.src = branding.logo;
        img.style.display = 'block';
    }

    function addTeamInput() {
        const div = document.createElement('div');
        div.className = 'team-input-row';
        div.innerHTML = '<input class="team-name" placeholder="×©× ×§×‘×•×¦×”">';
        document.getElementById('teamsContainer').appendChild(div);
    }

    tabHost.addEventListener("click", () => {
        tabHost.classList.add("active"); tabPlayer.classList.remove("active");
        hostMode.classList.remove("hidden"); playerMode.classList.add("hidden");
        adminFab.classList.add("hidden"); adminFloatingPanel.classList.add("hidden");
    });
    tabPlayer.addEventListener("click", () => {
        tabPlayer.classList.add("active"); tabHost.classList.remove("active");
        hostMode.classList.add("hidden"); playerMode.classList.remove("hidden");
        if(isHostAlsoPlayer && currentGameCode) adminFab.classList.remove("hidden");
    });
    adminFab.addEventListener("click", () => {
        adminFab.classList.add("hidden");
        adminFloatingPanel.classList.remove("hidden");
        refreshFloatOptions();
    });

    document.getElementById("createGameBtn").addEventListener("click", () => {
        const hostName = document.getElementById("hostName").value;
        const teamInputs = document.querySelectorAll('.team-name');
        const teamNames = Array.from(teamInputs).map(i => i.value).filter(v => v.trim() !== "");

        if(!hostName) return alert("× × ×œ×”×–×™×Ÿ ×©× ×× ×”×œ");
        if(teamNames.length < 2) return alert("×—×•×‘×” ×œ×¤×—×•×ª 2 ×§×‘×•×¦×•×ª");

        socket.emit("createGame", { hostName, teamNames, branding }, (res) => {
            if(res.ok) {
                currentGameCode = res.gameCode;
                localStorage.setItem("mil_hostGameCode", res.gameCode);
                renderGame(res.game);
                document.getElementById("hostPlayerName").value = hostName;
            } else alert(res.error);
        });
    });

    document.getElementById("openPlayerViewBtn").addEventListener("click", () => {
        const name = document.getElementById("hostPlayerName").value;
        const teamId = document.getElementById("hostPlayerTeamSelect").value;
        socket.emit("joinGame", { gameCode: currentGameCode, name, teamId }, (res) => {
            if(res.ok) {
                isHostAlsoPlayer = true;
                hostPlayerClientId = res.clientId;
                renderGame(res.game);
                tabPlayer.click();
            }
        });
    });

    document.getElementById("startRoundBtn").addEventListener("click", () => startRound());
    document.getElementById("floatStartBtn").addEventListener("click", () => startRound(true));
    
    function startRound(isFloat = false) {
        const teamId = isFloat ? document.getElementById("floatTeamSelect").value : document.getElementById("roundTeamSelect").value;
        const explainer = isFloat ? document.getElementById("floatExplainerSelect").value : document.getElementById("explainerSelect").value;
        const seconds = isFloat ? document.getElementById("floatSeconds").value : 60;

        socket.emit("startRound", { gameCode: currentGameCode, teamId, explainerClientId: explainer, roundSeconds: seconds }, (res) => {
            if(!res.ok) alert("×©×’×™××”: " + (res.error || "×œ× × ×™×ª×Ÿ ×œ×”×ª×—×™×œ"));
            else if(isFloat) { adminFloatingPanel.classList.add("hidden"); adminFab.classList.remove("hidden"); }
        });
    }

    document.getElementById("stopRoundBtn").addEventListener("click", () => socket.emit("endRound", { gameCode: currentGameCode }));
    document.getElementById("floatStopBtn").addEventListener("click", () => socket.emit("endRound", { gameCode: currentGameCode }));

    window.endGame = () => { if(confirm("×œ×¡×’×•×¨ ××ª ×”××©×—×§?")) socket.emit("endGame", { gameCode: currentGameCode }); };

    document.getElementById("hostBtnCorrect").addEventListener("click", () => {
        socket.emit("changeRoundScore", { gameCode: currentGameCode, delta: 1 }, getNextWordHost);
    });
    document.getElementById("hostBtnSkip").addEventListener("click", () => {
        socket.emit("changeRoundScore", { gameCode: currentGameCode, delta: -1 }, getNextWordHost);
    });
    function getNextWordHost() {
        socket.emit("getNextWord", { gameCode: currentGameCode }, (res) => {
            if(res.ok) document.getElementById("hostPresenterWord").innerText = res.word;
        });
    }

    socket.on("gameUpdated", renderGame);
    
    socket.on("roundTick", (data) => {
        if(data.gameCode === currentGameCode) {
            const timeStr = Math.floor(data.secondsLeft/60).toString().padStart(2,'0') + ':' + (data.secondsLeft%60).toString().padStart(2,'0');
            document.getElementById("roundTimer").textContent = timeStr;
            document.getElementById("hostPlayerBigTimer").textContent = timeStr;
        }
    });

    socket.on("roundTimeUp", (data) => {
        let html = `<div style="text-align:center;"><img src="m3.png" style="height:80px;"></div>`;
        html += `<h3>${data.teamName}</h3><div style="font-size:1.5rem; font-weight:bold;">${data.roundScore} × ×§×•×“×•×ª</div>`;
        showModal("â° × ×’××¨ ×”×–××Ÿ!", html);
        hostIsCurrentExplainer = false;
        document.getElementById("hostPresenterSection").classList.add("hidden");
    });

    function renderGame(game) {
        if(!game) {
            document.getElementById("createGameCard").classList.remove("hidden");
            document.getElementById("activeGameControls").classList.add("hidden");
            isHostAlsoPlayer = false;
            return;
        }
        lastGameState = game;
        currentGameCode = game.code;
        
        document.getElementById("createGameCard").classList.add("hidden");
        document.getElementById("activeGameControls").classList.remove("hidden");
        document.getElementById("gameCodeDisplay").textContent = game.code;

        // ×¨×©×™××ª ×©×™×ª×•×£ ×§×‘×•×¦×•×ª
        const list = document.getElementById('teamsShareList');
        list.innerHTML = "";
        Object.values(game.teams).forEach(t => {
            const link = `${window.location.origin}/player.html?code=${game.code}&teamId=${t.id}&teamName=${encodeURIComponent(t.name)}`;
            const waLink = `https://wa.me/?text=${encodeURIComponent("×”×¦×˜×¨×¤×• ×œ×§×‘×•×¦×ª " + t.name + ": " + link)}`;
            list.innerHTML += `
              <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                  <span>${t.name}</span>
                  <a href="${waLink}" target="_blank" class="btn-whatsapp" style="padding:5px 10px; text-decoration:none; border-radius:5px;">×©×œ×— ×œ×§×‘×•×¦×”</a>
              </div>`;
        });

        // Dropdowns
        const selects = [document.getElementById("roundTeamSelect"), document.getElementById("inviteTeamSelect"), document.getElementById("hostPlayerTeamSelect"), document.getElementById("floatTeamSelect")];
        selects.forEach(sel => {
            const val = sel.value;
            sel.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×”</option>';
            Object.entries(game.teams).forEach(([tid, t]) => {
                 sel.innerHTML += `<option value="${tid}">${t.name}</option>`;
            });
            if(val && game.teams[val]) sel.value = val;
        });

        let scoreHtml = "";
        let playersHtml = "";
        Object.values(game.teams).forEach(t => {
            scoreHtml += `<div><strong>${t.name}:</strong> ${t.score}</div>`;
            let pNames = t.players.map(pid => game.playersByClientId[pid]?.name).join(", ");
            playersHtml += `<div style="margin-bottom:5px;"><b>${t.name}:</b> ${pNames || "××™×Ÿ ×©×—×§× ×™×"}</div>`;
        });
        document.getElementById("scoreboard").innerHTML = scoreHtml;
        document.getElementById("playersByTeam").innerHTML = playersHtml;

        if(isHostAlsoPlayer) {
            document.getElementById("hostPlayerJoinCard").classList.add("hidden");
            document.getElementById("hostPlayerGameCard").classList.remove("hidden");
            const myTeam = Object.values(game.teams).find(t => t.players.includes(hostPlayerClientId));
            if(myTeam) document.getElementById("hostPlayerTeamName").textContent = myTeam.name;
        }

        if(game.currentRound && game.currentRound.isActive) {
            document.getElementById("startRoundBtn").disabled = true;
            document.getElementById("stopRoundBtn").disabled = false;
            document.getElementById("roundStatus").textContent = `××©×—×§×™×: ${game.currentRound.explainerName}`;
            document.getElementById("hostRoundStatusPlayer").textContent = `××¡×‘×™×¨: ${game.currentRound.explainerName}`;
            
            if(game.currentRound.explainerId === hostPlayerClientId) {
                hostIsCurrentExplainer = true;
                document.getElementById("hostPresenterSection").classList.remove("hidden");
                if(document.getElementById("hostPresenterWord").textContent === "××™×œ×”") getNextWordHost();
            } else {
                hostIsCurrentExplainer = false;
                document.getElementById("hostPresenterSection").classList.add("hidden");
            }
        } else {
            document.getElementById("startRoundBtn").disabled = false;
            document.getElementById("stopRoundBtn").disabled = true;
            document.getElementById("roundStatus").textContent = "×”××ª× ×”";
            document.getElementById("roundTimer").textContent = "--:--";
            hostIsCurrentExplainer = false;
            document.getElementById("hostPresenterSection").classList.add("hidden");
        }
    }
    
    function refreshFloatOptions() {
        const teamId = document.getElementById("floatTeamSelect").value;
        const expSel = document.getElementById("floatExplainerSelect");
        expSel.innerHTML = '<option value="">××•×˜×•××˜×™</option>';
        if(teamId && lastGameState.teams[teamId]) {
            lastGameState.teams[teamId].players.forEach(pid => {
                expSel.innerHTML += `<option value="${pid}">${lastGameState.playersByClientId[pid].name}</option>`;
            });
        }
    }
    document.getElementById("floatTeamSelect").addEventListener("change", refreshFloatOptions);

    const savedCode = localStorage.getItem("mil_hostGameCode");
    if(savedCode) socket.emit("hostReconnect", { gameCode: savedCode }, (res) => {
        if(res.ok) renderGame(res.game);
    });

    function showModal(title, body) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalContent").innerHTML = body;
        document.getElementById("customModal").classList.add("active");
    }
    function openSupport() {
        let text = "×©×œ×•×, ×× ×™ ×¦×¨×™×š ×¢×–×¨×” ×‘××™×œ×× ×™×”.";
        let name = document.getElementById("hostName").value || "×× ×”×œ";
        if(currentGameCode) text += ` (×§×•×“ ××©×—×§: ${currentGameCode}, ×× ×”×œ: ${name})`;
        window.open(`https://wa.me/972504000024?text=${encodeURIComponent(text)}`, '_blank');
    }
    
    document.getElementById("whatsappInviteBtn").addEventListener("click", () => {
        const tid = document.getElementById("inviteTeamSelect").value;
        if(!tid) return alert("×‘×—×¨ ×§×‘×•×¦×”");
        const tName = lastGameState.teams[tid].name;
        const link = `${window.location.origin}/player.html?code=${currentGameCode}&teamId=${tid}&teamName=${encodeURIComponent(tName)}&autoJoin=1`;
        const text = `ğŸ”¥ ××•×–×× ×™× ×œ××©×—×§ ××™×œ×× ×™×”!\n×œ×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×ª "${tName}" ×œ×—×¦×• ×¢×œ ×”×§×™×©×•×¨:\n${link}`;
        window.open("https://wa.me/?text=" + encodeURIComponent(text));
    });
  </script>
</body>
</html>
