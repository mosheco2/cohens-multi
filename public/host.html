<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××™×œ×× ×™×” - × ×™×”×•×œ ××©×—×§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ×¤×•× ×˜ ×¢×’×•×œ ×•×›×™×¤×™ ×›××• ×‘×©××¨ ×”××¡×›×™× -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root {
      font-size: 16px;
    }
    * {
      box-sizing: border-box;
      font-family: "Varela Round", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #FFF8EA;
      color: #2B1E4A;
      display: block;
      min-height: 100vh;
      font-size: 1rem;
      position: relative;
    }

    /* "×”×™×œ×”" ×¦×‘×¢×•× ×™×ª ×‘×¨×§×¢ ×›××• ×‘×©××¨ ×”××¡×›×™× */
    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 280px;
      height: 280px;
      border-radius: 50%;
      z-index: -1;
    }
    body::before {
      top: -130px;
      left: -70px;
      background: radial-gradient(circle at center,
        rgba(248, 71, 121, 0.30),
        transparent 60%);
    }
    body::after {
      bottom: -150px;
      right: -50px;
      background: radial-gradient(circle at center,
        rgba(21, 196, 193, 0.28),
        transparent 60%);
    }

    .app {
      max-width: 1024px;
      width: 100%;
      padding: 20px 14px 40px;
      margin: 0 auto;
    }

    .card {
      background: #FFFFFF;
      border-radius: 26px;
      padding: 18px 16px 20px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(43, 30, 74, 0.06);
      margin-bottom: 16px;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.87rem;
      color: #6B618F;
    }

    input, select {
      width: 100%;
      padding: 9px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43, 30, 74, 0.22);
      background: #FFFDF7;
      color: #2B1E4A;
      font-size: 0.98rem;
    }

    input::placeholder,
    select::placeholder {
      color: #B0A6CC;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #15C4C1;
      box-shadow: 0 0 0 1px rgba(21, 196, 193, 0.6);
      background: #FFFFFF;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row > div {
      flex: 1 1 200px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.96rem;
      font-weight: 700;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        filter 0.08s ease;
      white-space: nowrap;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #F6A21E, #F7C948);
      color: #2B1E4A;
      box-shadow: 0 12px 28px rgba(246, 162, 30, 0.45);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(246, 162, 30, 0.55);
      filter: brightness(1.02);
    }

    .btn-success {
      background: linear-gradient(135deg, #15C4C1, #22C5E8);
      color: #FFFFFF;
      box-shadow: 0 12px 28px rgba(21, 196, 193, 0.45);
    }
    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(21, 196, 193, 0.55);
      filter: brightness(1.02);
    }

    .btn-danger {
      background: #EF4444;
      color: #FFF5F5;
      box-shadow: 0 10px 22px rgba(239, 68, 68, 0.3);
    }
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(239, 68, 68, 0.4);
    }

    .btn-ghost {
      background: #FFFFFF;
      border: 1px solid rgba(43, 30, 74, 0.24);
      color: #2B1E4A;
    }
    .btn-ghost:hover {
      background: #FFF3DA;
    }

    .btn-small {
      padding: 6px 11px;
      font-size: 0.82rem;
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      color: #FFFFFF;
      gap: 6px;
      background: linear-gradient(135deg, #F84779, #F6A21E);
      box-shadow: 0 10px 24px rgba(248, 71, 121, 0.4);
    }

    .logo-small {
      height: 46px;
      width: auto;
      border-radius: 16px;
      object-fit: contain;
      background: #FFFDF7;
      box-shadow:
        0 0 0 2px rgba(255, 255, 255, 1),
        0 12px 26px rgba(0, 0, 0, 0.12);
      padding: 4px 8px;
    }

    .status-text {
      font-size: 0.9rem;
      color: #7C7598;
    }
    .status-strong {
      font-size: 1rem;
      font-weight: 700;
      color: #2B1E4A;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 800px) {
      .grid-2 {
        grid-template-columns: 1.2fr 0.9fr;
      }
    }

    .team-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      margin-bottom: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(43, 30, 74, 0.02);
    }
    .team-score {
      font-weight: 800;
      font-size: 1.05rem;
      color: #2B1E4A;
    }
    .team-players {
      font-size: 0.8rem;
      color: #9C93B8;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.5);
      color: #7C7598;
      gap: 4px;
      background: #FFFFFF;
    }

    .ad-banner {
      display: block;
      margin-top: 6px;
      border-radius: 20px;
      padding: 4px;
      background: linear-gradient(
        135deg,
        rgba(248, 71, 121, 0.16),
        rgba(21, 196, 193, 0.20)
      );
      border: 1px solid rgba(43, 30, 74, 0.18);
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    .ad-banner img {
      width: 100%;
      display: block;
      border-radius: 16px;
    }

    .hidden {
      display: none !important;
    }

    /* ×˜×™×™××¨ */
    #roundTimer {
      margin-top: 4px;
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #F84779;
    }

    /* ×›×•×ª×¨×ª ×¢××•×“ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .page-header-main {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    @media (max-width: 640px) {
      body {
        font-size: 1.05rem;
      }
      .app {
        padding: 16px 10px 32px;
      }
      .card {
        padding: 18px 14px 20px;
        border-radius: 20px;
      }
      h1 {
        font-size: 1.6rem;
      }
      h3 {
        font-size: 1.05rem;
      }
      label {
        font-size: 0.9rem;
      }
      input, select {
        font-size: 1rem;
      }
      .btn {
        font-size: 1rem;
        padding: 10px 16px;
      }
      #roundTimer {
        font-size: 1.9rem;
        text-align: center;
        margin-top: 8px;
      }
      .team-row {
        font-size: 0.98rem;
      }
      .team-players {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×•×ª×¨×ª + ×™×¦×™×¨×ª ××©×—×§ -->
    <div class="card">
      <div class="page-header">
        <div class="page-header-main">
          <img id="host-logo" class="logo-small hidden" alt="××™×œ×× ×™×” ×œ×•×’×•" />
          <div>
            <div class="chip">××™×œ×× ×™×” Â· × ×™×”×•×œ ××©×—×§ ğŸ‘‘</div>
            <h1 style="margin:4px 0 0; font-size:1.7rem;">×× ×”×œ ×”××©×—×§</h1>
          </div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn btn-ghost btn-small" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost btn-small" onclick="location.href='/'">â¬… ××¡×š ×”×‘×™×ª</button>
        </div>
      </div>

      <p class="status-text" style="margin-top:8px;">
        ×›××Ÿ ×¤×•×ª×—×™× ××©×—×§ ××™×œ×× ×™×” ×—×“×©, ××’×“×™×¨×™× ×§×‘×•×¦×•×ª, ×–××Ÿ ×¡×™×‘×•×‘ ×•×™×¢×“ × ×§×•×“×•×ª â€“ ×•××©× × ×•×ª× ×™× ×œ×©×—×§× ×™× ×œ×¨×•×¥ ×¢×œ ×”××™×œ×™× ğŸ˜„
      </p>

      <div class="row">
        <div>
          <label for="hostName">×©× ×”×× ×”×œ</label>
          <input id="hostName" type="text" placeholder="×œ×“×•×’××”: ××©×”" />
        </div>
        <div>
          <label for="numTeams">××¡×¤×¨ ×§×‘×•×¦×•×ª</label>
          <select id="numTeams">
            <option value="2">2 ×§×‘×•×¦×•×ª</option>
            <option value="3">3 ×§×‘×•×¦×•×ª</option>
            <option value="4">4 ×§×‘×•×¦×•×ª</option>
            <option value="5">5 ×§×‘×•×¦×•×ª</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="targetScore">×™×¢×“ × ×§×•×“×•×ª ×œ× ×™×¦×—×•×Ÿ</label>
          <input id="targetScore" type="number" min="5" max="200" value="30" />
        </div>
        <div>
          <label for="roundSeconds">××©×š ×¡×™×‘×•×‘ (×©× ×™×•×ª)</label>
          <input id="roundSeconds" type="number" min="10" max="300" value="60" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>×©××•×ª ×œ×§×‘×•×¦×•×ª (×œ× ×—×•×‘×”)</label>
          <input id="teamNameA" type="text" placeholder="×§×‘×•×¦×” 1" />
        </div>
        <div>
          <label>&nbsp;</label>
          <input id="teamNameB" type="text" placeholder="×§×‘×•×¦×” 2" />
        </div>
      </div>
      <div class="row">
        <div>
          <input id="teamNameC" type="text" placeholder="×§×‘×•×¦×” 3 (××•×¤×¦×™×•× ×œ×™)" />
        </div>
        <div>
          <input id="teamNameD" type="text" placeholder="×§×‘×•×¦×” 4 (××•×¤×¦×™×•× ×œ×™)" />
        </div>
      </div>
      <div class="row">
        <div>
          <input id="teamNameE" type="text" placeholder="×§×‘×•×¦×” 5 (××•×¤×¦×™×•× ×œ×™)" />
        </div>
      </div>

      <div style="margin-top:8px; margin-bottom:6px;">
        <label>×§×˜×’×•×¨×™×•×ª ××™×œ×™×</label>
        <div class="status-text">
          ×× ×œ× ×ª×¡××Ÿ ×›×œ×•× â€“ ×”××©×—×§ ×™×©×ª××© ×‘×›×œ ×”×§×˜×’×•×¨×™×•×ª.
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; font-size:0.82rem;">
          <label style="font-weight:600;">
            <input type="checkbox" id="catSelectAll" /> ×‘×—×¨ ×”×›×œ
          </label>
          <label><input type="checkbox" class="cat-checkbox" value="general" checked /> ×›×œ×œ×™</label>
          <label><input type="checkbox" class="cat-checkbox" value="family" checked /> ××©×¤×—×”</label>
          <label><input type="checkbox" class="cat-checkbox" value="food" checked /> ××•×›×œ</label>
          <label><input type="checkbox" class="cat-checkbox" value="work" /> ×¢×‘×•×“×”</label>
          <label><input type="checkbox" class="cat-checkbox" value="hard" /> ×§×©×”</label>
          <label><input type="checkbox" class="cat-checkbox" value="sports" /> ×¡×¤×•×¨×˜</label>
          <label><input type="checkbox" class="cat-checkbox" value="technology" /> ×˜×›× ×•×œ×•×’×™×”</label>
          <label><input type="checkbox" class="cat-checkbox" value="travel" /> ×˜×™×•×œ×™×</label>
          <label><input type="checkbox" class="cat-checkbox" value="school" /> ×‘×™×ª ×¡×¤×¨</label>
          <label><input type="checkbox" class="cat-checkbox" value="entertainment" /> ×¡×¨×˜×™× ×•×¡×“×¨×•×ª</label>
          <label><input type="checkbox" class="cat-checkbox" value="music" /> ××•×–×™×§×”</label>
          <label><input type="checkbox" class="cat-checkbox" value="nature" /> ×˜×‘×¢</label>
          <label><input type="checkbox" class="cat-checkbox" value="holidays" /> ×—×’×™×</label>
          <label><input type="checkbox" class="cat-checkbox" value="animals" /> ×‘×¢×œ×™ ×—×™×™×</label>
          <label><input type="checkbox" class="cat-checkbox" value="objects" /> ×—×¤×¦×™×</label>
        </div>
      </div>

      <button id="createGameBtn" class="btn btn-primary" style="margin-top:8px;">×™×¦×™×¨×ª ××©×—×§ ×—×“×©</button>
      <button id="endGameBtn" class="btn btn-danger" style="margin-top:8px; margin-right:6px;" disabled>×¡×’×™×¨×ª ××©×—×§</button>

      <div id="hostStatus" class="status-text" style="margin-top:8px;"></div>
    </div>

    <!-- ×¡×˜×˜×•×¡ ××©×—×§ + ×©×œ×™×˜×” ×‘×¡×™×‘×•×‘ + × ×™×§×•×“ -->
    <div class="grid-2">
      <!-- ×¦×“ ×©×××œ: ×¡×˜×˜×•×¡ ×•×¤×§×“×™× -->
      <div class="card">
        <h3 style="margin:0 0 6px;">×¡×˜×˜×•×¡ ××©×—×§</h3>
        <div id="gameCodeRow" class="status-text">××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢.</div>
        <div id="roundStatus" class="status-text" style="margin-top:4px;">××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ.</div>
        <div id="roundTimer" class="status-strong">×˜×™×™××¨: --:--</div>

        <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 0;" />

        <h3 style="margin:0 0 6px;">×©×œ×™×˜×” ×‘×¡×™×‘×•×‘</h3>
        <div class="status-text" style="margin-bottom:6px;">
          ×‘×—×¨ ×§×‘×•×¦×” ×œ×¡×™×‘×•×‘ ×”×‘× ×•××¡×‘×™×¨ (×× ×ª×¨×¦×”). ×× ×œ× ×ª×‘×—×¨ ××¡×‘×™×¨ â€“ ×”××©×—×§ ×™×‘×—×¨ ×©×—×§×Ÿ ×¨××©×•×Ÿ ×‘×§×‘×•×¦×”.
        </div>
        <div class="row">
          <div>
            <label for="roundTeamSelect">×§×‘×•×¦×” ×œ×¡×™×‘×•×‘</label>
            <select id="roundTeamSelect">
              <option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>
            </select>
          </div>
          <div>
            <label for="roundSecondsInline">××©×š ×¡×™×‘×•×‘ (×©× ×™×•×ª)</label>
            <input id="roundSecondsInline" type="number" min="10" max="300" value="60" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="explainerSelect">××¡×‘×™×¨ (××•×¤×¦×™×•× ×œ×™)</label>
            <select id="explainerSelect">
              <option value="">×‘×—×™×¨×” ××•×˜×•××˜×™×ª</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:6px; flex-wrap:wrap;">
          <button id="startRoundBtn" class="btn btn-success">×”×ª×—×œ ×¡×™×‘×•×‘</button>
          <button id="stopRoundBtn" class="btn btn-ghost" disabled>×¡×™×•× ×¡×™×‘×•×‘</button>
        </div>
      </div>

      <!-- ×¦×“ ×™××™×Ÿ: × ×™×§×•×“ ×•×©×—×§× ×™× -->
      <div class="card">
        <h3 style="margin:0 0 6px;">× ×™×§×•×“ ×•×§×‘×•×¦×•×ª</h3>
        <div id="scoreTarget" class="status-text"></div>
        <div id="scoreboard"></div>

        <hr style="border:none; border-top:1px solid rgba(180, 169, 214, 0.5); margin:10px 8px;" />

        <h3 style="margin:0 0 6px; font-size:0.95rem;">×©×—×§× ×™× ×œ×¤×™ ×§×‘×•×¦×”</h3>
        <div id="playersByTeam" class="status-text"></div>

        <div id="host-banner-slot" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let currentGameCode = null;
    let lastGameState = null;
    let roundTimerId = null;
    let roundTimeLeft = 0;
    let roundActive = false;

    const hostNameInput = document.getElementById("hostName");
    const numTeamsSelect = document.getElementById("numTeams");
    const targetScoreInput = document.getElementById("targetScore");
    const roundSecondsInput = document.getElementById("roundSeconds");
    const teamNameAInput = document.getElementById("teamNameA");
    const teamNameBInput = document.getElementById("teamNameB");
    const teamNameCInput = document.getElementById("teamNameC");
    const teamNameDInput = document.getElementById("teamNameD");
    const teamNameEInput = document.getElementById("teamNameE");
    const catCheckboxes = document.querySelectorAll(".cat-checkbox");
    const selectAllCatsCheckbox = document.getElementById("catSelectAll");

    const createGameBtn = document.getElementById("createGameBtn");
    const endGameBtn = document.getElementById("endGameBtn");
    const hostStatus = document.getElementById("hostStatus");

    const gameCodeRow = document.getElementById("gameCodeRow");
    const roundStatusEl = document.getElementById("roundStatus");
    const roundTimerEl = document.getElementById("roundTimer");

    const roundTeamSelect = document.getElementById("roundTeamSelect");
    const roundSecondsInline = document.getElementById("roundSecondsInline");
    const explainerSelect = document.getElementById("explainerSelect");
    const startRoundBtn = document.getElementById("startRoundBtn");
    const stopRoundBtn = document.getElementById("stopRoundBtn");

    const scoreboardEl = document.getElementById("scoreboard");
    const scoreTargetEl = document.getElementById("scoreTarget");
    const playersByTeamEl = document.getElementById("playersByTeam");
    const hostBannerSlot = document.getElementById("host-banner-slot");
    const hostLogoEl = document.getElementById("host-logo");

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, "0");
      const s = (seconds % 60).toString().padStart(2, "0");
      return m + ":" + s;
    }

    function updateRoundTimerUI() {
      if (!roundTimerEl) return;
      if (!roundActive) {
        roundTimerEl.textContent = "×˜×™×™××¨: --:--";
      } else {
        roundTimerEl.textContent = "×˜×™×™××¨: " + formatTime(roundTimeLeft);
      }
    }

    function startLocalRoundTimer(duration) {
      clearInterval(roundTimerId);
      roundActive = true;
      roundTimeLeft = duration;
      updateRoundTimerUI();
      roundTimerId = setInterval(() => {
        roundTimeLeft--;
        if (roundTimeLeft <= 0) {
          roundTimeLeft = 0;
          updateRoundTimerUI();
          clearInterval(roundTimerId);
          roundActive = false;
          if (currentGameCode) {
            socket.emit("endRound", { gameCode: currentGameCode }, () => {});
          }
        } else {
          updateRoundTimerUI();
        }
      }, 1000);
    }

    function stopLocalRoundTimer() {
      clearInterval(roundTimerId);
      roundActive = false;
      roundTimeLeft = 0;
      updateRoundTimerUI();
    }

    function collectCategories() {
      const selected = [];
      catCheckboxes.forEach((cb) => {
        if (cb.checked) selected.push(cb.value);
      });
      return selected;
    }

    if (selectAllCatsCheckbox) {
      selectAllCatsCheckbox.addEventListener("change", () => {
        const checked = selectAllCatsCheckbox.checked;
        catCheckboxes.forEach((cb) => {
          cb.checked = checked;
        });
      });

      catCheckboxes.forEach((cb) => {
        cb.addEventListener("change", () => {
          let allChecked = true;
          catCheckboxes.forEach((c2) => {
            if (!c2.checked) allChecked = false;
          });
          selectAllCatsCheckbox.checked = allChecked;
        });
      });
    }

    function refreshExplainerOptions() {
      if (!explainerSelect) return;
      const teamId = roundTeamSelect.value;
      explainerSelect.innerHTML = '<option value="">×‘×—×™×¨×” ××•×˜×•××˜×™×ª</option>';
      if (!teamId || !lastGameState || !lastGameState.teams) return;

      const team = lastGameState.teams[teamId];
      if (!team || !Array.isArray(team.players)) return;

      const playersMap = lastGameState.players || lastGameState.playersByClientId || {};

      team.players.forEach((cid, idx) => {
        const opt = document.createElement("option");
        opt.value = cid;
        const p = playersMap[cid];
        const displayName = p && p.name ? p.name : ("×©×—×§×Ÿ #" + (idx + 1));
        opt.textContent = displayName;
        explainerSelect.appendChild(opt);
      });
    }

    roundTeamSelect.addEventListener("change", () => {
      refreshExplainerOptions();
    });

    function renderGameState(game) {
      lastGameState = game;
      if (!game) {
        currentGameCode = null;
        gameCodeRow.textContent = "××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢.";
        scoreTargetEl.textContent = "";
        scoreboardEl.innerHTML = "";
        playersByTeamEl.textContent = "";
        endGameBtn.disabled = true;
        startRoundBtn.disabled = true;
        stopRoundBtn.disabled = true;
        roundTeamSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>';
        refreshExplainerOptions();
        return;
      }

      const playersMap = game.players || game.playersByClientId || {};

      currentGameCode = game.code;
      endGameBtn.disabled = false;
      gameCodeRow.innerHTML =
        '×§×•×“ ××©×—×§: <span class="status-strong">' + game.code + "</span>";

      if (game.targetScore) {
        scoreTargetEl.textContent =
          "××©×—×§ ×¢×“ " + game.targetScore + " × ×§×•×“×•×ª.";
      } else {
        scoreTargetEl.textContent = "";
      }

      scoreboardEl.innerHTML = "";
      const teams = game.teams || {};
      const teamIds = Object.keys(teams);

      roundTeamSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×”...</option>';

      teamIds.forEach((id) => {
        const t = teams[id];
        const div = document.createElement("div");
        div.className = "team-row";

        const left = document.createElement("span");
        left.textContent = t.name || "×§×‘×•×¦×” " + id;

        const middle = document.createElement("span");
        middle.className = "team-players";
        const players = t.players || [];
        const playersCount = players.length;
        middle.textContent = playersCount ? playersCount + " ×©×—×§× ×™×" : "××™×Ÿ ×©×—×§× ×™× ×¢×“×™×™×Ÿ";

        const right = document.createElement("span");
        right.className = "team-score";
        right.textContent = t.score || 0;

        const leftWrap = document.createElement("div");
        leftWrap.style.display = "flex";
        leftWrap.style.flexDirection = "column";
        leftWrap.appendChild(left);
        leftWrap.appendChild(middle);

        div.appendChild(leftWrap);
        div.appendChild(right);
        scoreboardEl.appendChild(div);

        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = t.name || "×§×‘×•×¦×” " + id;
        roundTeamSelect.appendChild(opt);
      });

      playersByTeamEl.innerHTML = "";
      teamIds.forEach((id) => {
        const t = teams[id];
        const players = t.players || [];
        const teamTitle = document.createElement("div");
        teamTitle.style.marginTop = "4px";
        teamTitle.innerHTML =
          "<strong>" + (t.name || "×§×‘×•×¦×” " + id) + "</strong> (" + players.length + " ×©×—×§× ×™×)";
        playersByTeamEl.appendChild(teamTitle);

        if (players.length) {
          const ul = document.createElement("ul");
          ul.style.margin = "2px 0 4px";
          ul.style.paddingRight = "1.1rem";
          players.forEach((cid, idx) => {
            const li = document.createElement("li");
            const p = playersMap[cid];
            li.textContent = p && p.name ? p.name : ("×©×—×§×Ÿ #" + (idx + 1));
            ul.appendChild(li);
          });
          playersByTeamEl.appendChild(ul);
        }
      });

      startRoundBtn.disabled = !teamIds.length;
      refreshExplainerOptions();
    }

    createGameBtn.addEventListener("click", () => {
      hostStatus.textContent = "";

      const hostName = hostNameInput.value.trim() || "×× ×”×œ";
      const numTeams = parseInt(numTeamsSelect.value || "2", 10);
      const targetScore = parseInt(targetScoreInput.value || "30", 10);
      const defaultRoundSeconds = parseInt(roundSecondsInput.value || "60", 10);
      const categories = collectCategories();

      const teamNames = [
        teamNameAInput.value.trim(),
        teamNameBInput.value.trim(),
        teamNameCInput.value.trim(),
        teamNameDInput.value.trim(),
        teamNameEInput.value.trim(),
      ];

      socket.emit(
        "createGame",
        {
          hostName,
          numTeams,
          teamNames,
          targetScore,
          defaultRoundSeconds,
          categories,
        },
        (res) => {
          if (!res || !res.ok) {
            hostStatus.textContent =
              (res && res.error) || "×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×—×§.";
            return;
          }
          renderGameState(res.game);
          hostStatus.textContent =
            "××©×—×§ ×—×“×© × ×•×¦×¨. ×©×ª×£ ××ª ×”×©×—×§× ×™× ×‘×§×•×“: " + res.gameCode;
          roundStatusEl.textContent = "××™×Ÿ ×¡×™×‘×•×‘ ×¤×¢×™×œ ×›×¨×’×¢.";
          stopLocalRoundTimer();
        }
      );
    });

    startRoundBtn.addEventListener("click", () => {
      if (!currentGameCode || !lastGameState) return;
      const teamId = roundTeamSelect.value;
      if (!teamId) {
        alert("×‘×—×¨ ×§×‘×•×¦×” ×œ×¡×™×‘×•×‘.");
        return;
      }

      const teams = lastGameState.teams || {};
      const team = teams[teamId];
      if (!team || !team.players || !team.players.length) {
        alert("××™×Ÿ ×©×—×§× ×™× ×‘×§×‘×•×¦×” ×”× ×‘×—×¨×ª.");
        return;
      }

      const seconds = parseInt(
        roundSecondsInline.value || lastGameState.defaultRoundSeconds || 60,
        10
      );

      let explainerId = explainerSelect && explainerSelect.value;
      if (!explainerId) {
        explainerId = team.players[0];
      }

      socket.emit(
        "startRound",
        {
          gameCode: currentGameCode,
          teamId,
          explainerId,
          roundSeconds: seconds,
        },
        (res) => {
          if (!res || !res.ok) {
            alert((res && res.error) || "×©×’×™××” ×‘×”×ª×—×œ×ª ×”×¡×™×‘×•×‘.");
            return;
          }
        }
      );
    });

    stopRoundBtn.addEventListener("click", () => {
      if (!currentGameCode) return;
      socket.emit("endRound", { gameCode: currentGameCode }, (res) => {
        if (!res || !res.ok) {
          alert((res && res.error) || "×©×’×™××” ×‘×¡×™×•× ×”×¡×™×‘×•×‘.");
        }
      });
    });

    endGameBtn.addEventListener("click", () => {
      if (!currentGameCode) return;
      const ok = confirm("×œ×¡×’×•×¨ ××ª ×”××©×—×§? ×”×©×—×§× ×™× ×™×§×‘×œ×• ×”×•×“×¢×ª ×¡×™×•×.");
      if (!ok) return;
      socket.emit("endGame", { gameCode: currentGameCode }, (res) => {
        if (!res || !res.ok) {
          alert((res && res.error) || "×©×’×™××” ×‘×¡×’×™×¨×ª ×”××©×—×§.");
        }
      });
    });

    socket.on("gameUpdated", (game) => {
      if (!currentGameCode || !game || game.code !== currentGameCode) return;
      renderGameState(game);
    });

    socket.on("roundStarted", (payload) => {
      if (!currentGameCode || !payload || payload.gameCode !== currentGameCode) return;
      const teams = lastGameState && lastGameState.teams ? lastGameState.teams : payload.teams;
      const team = teams && teams[payload.teamId];
      const teamName = team ? team.name || ("×§×‘×•×¦×” " + payload.teamId) : ("×§×‘×•×¦×” " + payload.teamId);

      roundStatusEl.textContent = "×¡×™×‘×•×‘ ×¤×¢×™×œ - " + teamName;
      startLocalRoundTimer(payload.roundTime || 60);
      startRoundBtn.disabled = true;
      stopRoundBtn.disabled = false;
    });

    socket.on("roundEnded", (payload) => {
      if (!currentGameCode || !payload || payload.gameCode !== currentGameCode) return;
      stopLocalRoundTimer();

      const teams = payload.teams || (lastGameState && lastGameState.teams) || {};
      const team = teams[payload.teamId];
      const teamName = team ? team.name || ("×§×‘×•×¦×” " + payload.teamId) : ("×§×‘×•×¦×” " + payload.teamId);

      const rs = typeof payload.roundScore === "number" ? payload.roundScore : 0;
      roundStatusEl.textContent =
        "×”×¡×™×‘×•×‘ ×©×œ " + teamName + " ×”×¡×ª×™×™×. (" + rs + " × ×§×•×“×•×ª ×‘×¡×™×‘×•×‘)";

      if (payload.scores && lastGameState && lastGameState.teams) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (lastGameState.teams[id]) {
            lastGameState.teams[id].score = s;
          }
        });
        renderGameState(lastGameState);
      }

      startRoundBtn.disabled = false;
      stopRoundBtn.disabled = true;
    });

    socket.on("gameEnded", (payload) => {
      if (!payload) return;

      stopLocalRoundTimer();
      startRoundBtn.disabled = true;
      stopRoundBtn.disabled = true;
      endGameBtn.disabled = true;

      const teams = payload.teams || {};
      const winnerTeamIds = payload.winnerTeamIds || [];
      let msg = "×”××©×—×§ ×”×¡×ª×™×™×.";
      if (winnerTeamIds.length) {
        const names = winnerTeamIds.map(
          (id) => (teams[id] && teams[id].name) || "×§×‘×•×¦×” " + id
        );
        if (names.length === 1) {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×! ×›×œ ×”×›×‘×•×“ ×œ-" + names[0] + " ğŸš€";
        } else {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×! ×ª×™×§×• ×‘×™×Ÿ: " + names.join(", ");
        }
      }
      roundStatusEl.textContent = msg;
      hostStatus.textContent = "×”××©×—×§ × ×¡×’×¨. ××¤×©×¨ ×œ×¤×ª×•×— ××©×—×§ ×—×“×© ××ª×™ ×©×ª×¨×¦×”.";

      renderGameState(null);
    });

    // ×˜×¢×™× ×ª ×œ×•×’×• ×•×‘×× ×¨ ×œ××¡×š ×× ×”×œ ×”××©×—×§
    (function loadBrandingForHost() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (!data) return;

          const logoCfg = data.logo;
          if (logoCfg && logoCfg.imageUrl && hostLogoEl) {
            hostLogoEl.src = logoCfg.imageUrl;
            hostLogoEl.alt = logoCfg.altText || "××™×œ×× ×™×”";
            hostLogoEl.classList.remove("hidden");
          }

          if (!hostBannerSlot) return;
          const cfg = data.host;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.className = "ad-banner";
          a.href = cfg.linkUrl;
          a.target = "_blank";
          a.rel = "noopener";

          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.alt = cfg.altText || "Banner";

          a.appendChild(img);
          hostBannerSlot.appendChild(a);
        })
        .catch(() => {});
    })();
  </script>
</body>
</html>
