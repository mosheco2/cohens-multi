<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×›×”× '×¡ - ×©×—×§×Ÿ</title><!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×›×”× '×¡ - ×©×—×§×Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-size: 16px;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      font-size: 1rem;
    }
    .app {
      max-width: 600px;
      width: 100%;
      padding: 20px 12px 32px;
    }
    .card {
      background: #020617;
      border-radius: 20px;
      padding: 16px 16px 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.85);
      border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 16px;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 1rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row > div {
      flex: 1 1 180px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #020617;
      box-shadow: 0 10px 25px rgba(56,189,248,0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(56,189,248,0.5);
    }
    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 25px rgba(34,197,94,0.35);
    }
    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(34,197,94,0.5);
    }
    .btn-danger {
      background: #ef4444;
      color: #fee2e2;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }
    .btn-ghost:hover {
      background: rgba(15,23,42,0.9);
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 0.8rem;
    }
    .btn-wide {
      width: 100%;
      justify-content: center;
    }
    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 0.8rem;
      color: #cbd5f5;
      gap: 6px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.22), rgba(15,23,42,0.95));
    }
    .logo-small {
      height: 32px;
      width: auto;
      border-radius: 10px;
      object-fit: contain;
    }
    .status-text {
      font-size: 0.9rem;
      color: #9ca3af;
    }
    .status-strong {
      font-size: 1rem;
      font-weight: 600;
    }
    .hidden {
      display: none !important;
    }
    .center {
      text-align: center;
    }

    /* ×˜×™×™××¨ ×’×“×•×œ ×•××•×“×’×© ×œ××¡×š ×©×—×§×Ÿ */
    #playerTimer {
      font-size: 2.2rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-align: center;
      margin: 10px 0;
    }

    /* ×§×•×¤×¡×ª ××™×œ×” ×œ××¡×‘×™×¨ */
    .word-box {
      margin-top: 10px;
      padding: 14px 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.16), rgba(15,23,42,0.98));
      text-align: center;
    }
    .word-label {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .word-text {
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .scoreboard {
      margin-top: 8px;
    }
    .team-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    .team-row.you {
      background: rgba(34,197,94,0.08);
      border-radius: 999px;
      padding: 4px 10px;
    }
    .team-name {
      font-weight: 600;
    }
    .team-score {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .team-tag {
      font-size: 0.75rem;
      color: #22c55e;
      margin-right: 6px;
    }

    .ad-banner {
      display: block;
      margin-top: 10px;
      border-radius: 18px;
      padding: 4px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.25), rgba(15,23,42,0.98));
      border: 1px solid rgba(148,163,184,0.6);
      text-decoration: none;
    }
    .ad-banner img {
      width: 100%;
      display: block;
      border-radius: 14px;
    }

    @media (max-width: 640px) {
      body {
        font-size: 1.05rem;
      }
      .app {
        padding: 16px 10px 28px;
      }
      .card {
        padding: 18px 14px 18px;
      }
      h1 {
        font-size: 1.5rem;
      }
      #playerTimer {
        font-size: 2.5rem;
        margin-top: 12px;
      }
      .word-text {
        font-size: 2.3rem;
      }
      .btn {
        font-size: 1.02rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×•×ª×¨×ª -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:8px;">
          <img id="player-logo" class="logo-small hidden" alt="×›×”× '×¡ ×œ×•×’×•" />
          <div>
            <div class="chip">×›×”× '×¡ Â· ×©×—×§×Ÿ</div>
            <h1 style="margin:4px 0 0;">××¡×š ×©×—×§×Ÿ</h1>
          </div>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-ghost btn-small" onclick="location.href='instructions.html'">â” ×”×•×¨××•×ª</button>
          <button class="btn btn-ghost btn-small" onclick="location.href='/'">â¬… ××¡×š ×”×‘×™×ª</button>
        </div>
      </div>
      <p class="status-text" style="margin-top:6px;">
        ×”×–×Ÿ ××ª ×”×©× ×©×œ×š, ×§×•×“ ×”××©×—×§ ×•×”×§×‘×•×¦×”, ×•×ª×ª×—×™×œ ×œ×©×—×§.
      </p>
    </div>

    <!-- ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§ -->
    <div id="joinSection" class="card">
      <div class="row">
        <div>
          <label for="playerName">×©× ×©×—×§×Ÿ</label>
          <input id="playerName" type="text" placeholder="×œ×“×•×’××”: ××©×”" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="gameCode">×§×•×“ ××©×—×§</label>
          <input id="gameCode" type="text" placeholder="× ××¡×¨ ×¢&quot;×™ ×× ×”×œ ×”××©×—×§" />
        </div>
        <div>
          <label for="teamSelect">×§×‘×•×¦×”</label>
          <select id="teamSelect">
            <option value="A">×§×‘×•×¦×” 1</option>
            <option value="B">×§×‘×•×¦×” 2</option>
            <option value="C">×§×‘×•×¦×” 3</option>
            <option value="D">×§×‘×•×¦×” 4</option>
            <option value="E">×§×‘×•×¦×” 5</option>
          </select>
        </div>
      </div>

      <button id="joinBtn" class="btn btn-primary btn-wide" style="margin-top:10px;">
        ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§
      </button>

      <div id="joinStatus" class="status-text" style="margin-top:8px;"></div>
    </div>

    <!-- ××¡×š ××©×—×§ ×œ××—×¨ ×”×¦×˜×¨×¤×•×ª -->
    <div id="gameSection" class="card hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="status-text">
            ××ª×” ××—×•×‘×¨ ×›Ö¾<span id="myNameLabel" class="status-strong">×©×—×§×Ÿ</span>
          </div>
          <div class="status-text">
            ×§×‘×•×¦×”: <span id="myTeamLabel" class="status-strong">â€”</span>
          </div>
        </div>
        <button id="leaveBtn" class="btn btn-danger btn-small">×™×¦×™××” ××”××©×—×§</button>
      </div>

      <hr style="border-color:rgba(31,41,55,0.9); margin:10px 0;" />

      <div id="roundInfo" class="status-text">
        ×××ª×™× ×™× ×œ×ª×—×™×œ×ª ×”×¡×™×‘×•×‘...
      </div>
      <div id="playerTimer">--:--</div>

      <div id="roleInfo" class="status-text center" style="margin-bottom:6px;">
        ×¢×“×™×™×Ÿ ××™×Ÿ ××¡×‘×™×¨ ×‘×¡×™×‘×•×‘ ×”×–×”.
      </div>

      <!-- ×§×•×¤×¡×ª ××™×œ×” ×œ××¡×‘×™×¨ -->
      <div id="wordBox" class="word-box hidden">
        <div class="word-label">×”××™×œ×” ×©×œ×š ×œ×”×¡×‘×™×¨:</div>
        <div id="wordText" class="word-text">---</div>
      </div>

      <!-- ×›×¤×ª×•×¨×™ ××¡×‘×™×¨ -->
      <div id="explainerButtons" class="hidden" style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button id="correctBtn" class="btn btn-success" style="flex:1;">âœ” ×”×¦×œ×™×—</button>
        <button id="skipBtn" class="btn btn-ghost" style="flex:1;">×“×œ×’ (××™× ×•×¡ × ×§×•×“×”)</button>
      </div>

      <!-- × ×™×§×•×“ ×•×§×‘×•×¦×•×ª -->
      <div class="scoreboard" id="playerScoreboard"></div>

      <div id="player-banner-slot" style="margin-top:10px;"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // ××¦×‘ ×’×œ×•×‘×œ×™
    let currentGameCode = null;
    let currentClientId = null;
    let currentTeamId = null;
    let currentGameState = null;
    let isExplainer = false;

    let roundTimerId = null;
    let roundTimeLeft = 0;
    let roundActive = false;

    // ××œ×× ×˜×™×
    const joinSection = document.getElementById("joinSection");
    const gameSection = document.getElementById("gameSection");

    const playerNameInput = document.getElementById("playerName");
    const gameCodeInput = document.getElementById("gameCode");
    const teamSelect = document.getElementById("teamSelect");
    const joinBtn = document.getElementById("joinBtn");
    const joinStatus = document.getElementById("joinStatus");

    const leaveBtn = document.getElementById("leaveBtn");
    const myNameLabel = document.getElementById("myNameLabel");
    const myTeamLabel = document.getElementById("myTeamLabel");

    const roundInfoEl = document.getElementById("roundInfo");
    const playerTimerEl = document.getElementById("playerTimer");
    const roleInfoEl = document.getElementById("roleInfo");

    const wordBox = document.getElementById("wordBox");
    const wordTextEl = document.getElementById("wordText");
    const explainerButtons = document.getElementById("explainerButtons");
    const correctBtn = document.getElementById("correctBtn");
    const skipBtn = document.getElementById("skipBtn");

    const playerScoreboardEl = document.getElementById("playerScoreboard");
    const playerLogoEl = document.getElementById("player-logo");
    const playerBannerSlot = document.getElementById("player-banner-slot");

    // ×˜×™×™××¨ ××§×•××™
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, "0");
      const s = (seconds % 60).toString().padStart(2, "0");
      return m + ":" + s;
    }

    function updatePlayerTimerUI() {
      if (!playerTimerEl) return;
      if (!roundActive) {
        playerTimerEl.textContent = "--:--";
      } else {
        playerTimerEl.textContent = formatTime(roundTimeLeft);
      }
    }

    function startLocalRoundTimer(duration) {
      clearInterval(roundTimerId);
      roundActive = true;
      roundTimeLeft = duration;
      updatePlayerTimerUI();
      roundTimerId = setInterval(() => {
        roundTimeLeft--;
        if (roundTimeLeft <= 0) {
          roundTimeLeft = 0;
          updatePlayerTimerUI();
          clearInterval(roundTimerId);
          roundActive = false;
        } else {
          updatePlayerTimerUI();
        }
      }, 1000);
    }

    function stopLocalRoundTimer() {
      clearInterval(roundTimerId);
      roundActive = false;
      roundTimeLeft = 0;
      updatePlayerTimerUI();
    }

    // × ×™×§×•×“
    function renderScoreboard(teams) {
      playerScoreboardEl.innerHTML = "";
      if (!teams) return;
      const ids = Object.keys(teams);
      ids.forEach((id) => {
        const t = teams[id];
        const row = document.createElement("div");
        row.className = "team-row";
        if (id === currentTeamId) {
          row.classList.add("you");
        }
        const left = document.createElement("div");
        const nameSpan = document.createElement("span");
        nameSpan.className = "team-name";
        nameSpan.textContent = t.name || "×§×‘×•×¦×” " + id;
        left.appendChild(nameSpan);
        if (id === currentTeamId) {
          const tag = document.createElement("span");
          tag.className = "team-tag";
          tag.textContent = "×”×§×‘×•×¦×” ×©×œ×š";
          left.appendChild(tag);
        }

        const scoreSpan = document.createElement("span");
        scoreSpan.className = "team-score";
        scoreSpan.textContent = t.score || 0;

        row.appendChild(left);
        row.appendChild(scoreSpan);
        playerScoreboardEl.appendChild(row);
      });
    }

    // ×©××™×¨×ª ××¦×‘ ×‘×“×¤×“×¤×Ÿ
    function savePlayerState() {
      if (!currentGameCode || !currentClientId) return;
      const obj = {
        gameCode: currentGameCode,
        clientId: currentClientId,
        playerName: playerNameInput.value.trim(),
        teamId: currentTeamId,
      };
      try {
        localStorage.setItem("cohens_player", JSON.stringify(obj));
      } catch (e) {}
    }

    function clearPlayerState() {
      try {
        localStorage.removeItem("cohens_player");
      } catch (e) {}
    }

    function switchToGameUI() {
      joinSection.classList.add("hidden");
      gameSection.classList.remove("hidden");
    }

    function switchToJoinUI() {
      gameSection.classList.add("hidden");
      joinSection.classList.remove("hidden");
      stopLocalRoundTimer();
      isExplainer = false;
      wordBox.classList.add("hidden");
      explainerButtons.classList.add("hidden");
      roundInfoEl.textContent = "×××ª×™× ×™× ×œ×ª×—×™×œ×ª ×”×¡×™×‘×•×‘...";
      roleInfoEl.textContent = "×¢×“×™×™×Ÿ ××™×Ÿ ××¡×‘×™×¨ ×‘×¡×™×‘×•×‘ ×”×–×”.";
      playerScoreboardEl.innerHTML = "";
    }

    // ×”×¦×˜×¨×¤×•×ª
    joinBtn.addEventListener("click", () => {
      joinStatus.textContent = "";
      const name = playerNameInput.value.trim();
      const codeRaw = gameCodeInput.value.trim();
      const teamId = teamSelect.value;

      if (!name) {
        joinStatus.textContent = "×¦×¨×™×š ×œ×”×–×™×Ÿ ×©× ×©×—×§×Ÿ.";
        return;
      }
      if (!codeRaw) {
        joinStatus.textContent = "×¦×¨×™×š ×œ×”×–×™×Ÿ ×§×•×“ ××©×—×§.";
        return;
      }

      const code = codeRaw.toUpperCase();
      currentTeamId = teamId;

      socket.emit(
        "joinGame",
        {
          gameCode: code,
          playerName: name,
          teamId,
          clientId: currentClientId || undefined,
        },
        (res) => {
          if (!res || !res.ok) {
            joinStatus.textContent = (res && res.error) || "×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ××©×—×§.";
            clearPlayerState();
            return;
          }
          currentGameCode = res.gameCode;
          currentClientId = res.clientId;
          currentGameState = res.game || null;

          myNameLabel.textContent = name;
          const team = currentGameState && currentGameState.teams && currentGameState.teams[teamId];
          myTeamLabel.textContent = team ? (team.name || ("×§×‘×•×¦×” " + teamId)) : ("×§×‘×•×¦×” " + teamId);

          renderScoreboard(currentGameState ? currentGameState.teams : null);

          savePlayerState();
          switchToGameUI();
        }
      );
    });

    // ×™×¦×™××” ××”××©×—×§
    leaveBtn.addEventListener("click", () => {
      if (currentGameCode && currentClientId) {
        socket.emit("leaveGame", { gameCode: currentGameCode, clientId: currentClientId });
      }
      currentGameCode = null;
      currentClientId = null;
      currentTeamId = null;
      currentGameState = null;
      clearPlayerState();
      switchToJoinUI();
      joinStatus.textContent = "×™×¦××ª ××”××©×—×§. ××¤×©×¨ ×œ×”×¦×˜×¨×£ ×œ××©×—×§ ×—×“×©.";
    });

    // ×›×¤×ª×•×¨×™ ××¡×‘×™×¨
    correctBtn.addEventListener("click", () => {
      if (!isExplainer || !currentGameCode) return;
      socket.emit("markCorrect", { gameCode: currentGameCode });
    });

    skipBtn.addEventListener("click", () => {
      if (!isExplainer || !currentGameCode) return;
      socket.emit("skipWord", { gameCode: currentGameCode });
    });

    // ××™×¨×•×¢×™ ×¡×•×§×˜
    socket.on("gameUpdated", (game) => {
      if (!currentGameCode || !game || game.code !== currentGameCode) return;
      currentGameState = game;
      if (!currentTeamId && game.teams) {
        // fallback ×× ××©×”×• ××‘×“
        currentTeamId = Object.keys(game.teams)[0];
      }
      renderScoreboard(game.teams);
    });

    socket.on("roundStarted", (payload) => {
      if (!currentGameCode || !payload || payload.gameCode !== currentGameCode) return;
      const teams = (currentGameState && currentGameState.teams) || payload.teams || {};
      const t = teams[payload.teamId];
      const teamName = t ? (t.name || ("×§×‘×•×¦×” " + payload.teamId)) : ("×§×‘×•×¦×” " + payload.teamId);

      roundInfoEl.textContent = "×¡×™×‘×•×‘ ×¤×¢×™×œ - " + teamName;
      startLocalRoundTimer(payload.roundTime || 60);

      isExplainer = (payload.explainerId === currentClientId);
      if (isExplainer) {
        roleInfoEl.textContent = "××ª×” ×”××¡×‘×™×¨! ××œ ×ª×’×™×“ ××ª ×”××™×œ×”, ×¨×§ ×ª×¡×‘×™×¨ ğŸ˜‰";
        wordBox.classList.remove("hidden");
        explainerButtons.classList.remove("hidden");
      } else {
        roleInfoEl.textContent = "××ª× ×”×× ×—×©×™×! ×”×§×©×™×‘×• ×˜×•×‘ ×œ×”×¡×‘×¨×™× ğŸš€";
        wordBox.classList.add("hidden");
        explainerButtons.classList.add("hidden");
      }
    });

    socket.on("wordForExplainer", (data) => {
      if (!isExplainer) return;
      wordTextEl.textContent = data && data.word ? data.word : "---";
    });

    socket.on("scoreUpdated", (payload) => {
      if (!currentGameCode || !payload || payload.gameCode !== currentGameCode) return;
      const teams = payload.teams || (currentGameState && currentGameState.teams);
      if (teams) {
        if (!currentGameState) currentGameState = {};
        currentGameState.teams = teams;
        renderScoreboard(teams);
      }
    });

    socket.on("roundEnded", (payload) => {
      if (!currentGameCode || !payload || payload.gameCode !== currentGameCode) return;
      stopLocalRoundTimer();

      const teams = payload.teams || (currentGameState && currentGameState.teams) || {};
      if (!currentGameState) currentGameState = {};
      currentGameState.teams = teams;
      renderScoreboard(teams);

      const rs = typeof payload.roundScore === "number" ? payload.roundScore : 0;
      let msg = "";
      if (rs < 5) {
        msg = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×.\n×ª×•×¦××”: " + rs + " × ×§×•×“×•×ª.\n××ª× ×—×œ×©×™× ğŸ˜…";
      } else if (rs <= 10) {
        msg = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×.\n×ª×•×¦××”: " + rs + " × ×§×•×“×•×ª.\n×¦×•×•×ª × ×—××“ ×”×™×™×ª×™ ××•××¨ ğŸ˜‰";
      } else {
        msg = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×.\n×ª×•×¦××”: " + rs + " × ×§×•×“×•×ª.\n××ª× ×—×–×§×™× ×‘××™×œ×™× ××”? ××§×•×•×” ×©×’× ×‘××¢×©×™× ğŸ’ª";
      }
      alert(msg);

      roundInfoEl.textContent = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×. ×××ª×™× ×™× ×œ×¡×™×‘×•×‘ ×”×‘×.";
      roleInfoEl.textContent = "×¢×“×™×™×Ÿ ××™×Ÿ ××¡×‘×™×¨ ×‘×¡×™×‘×•×‘ ×”×–×”.";
      isExplainer = false;
      wordBox.classList.add("hidden");
      explainerButtons.classList.add("hidden");
    });

    socket.on("gameEnded", (payload) => {
      if (!payload) return;
      if (!currentGameCode || payload.gameCode !== currentGameCode) return;

      stopLocalRoundTimer();

      const teams = payload.teams || {};
      const winners = payload.winnerTeamIds || [];
      let msg = "×”××©×—×§ ×”×¡×ª×™×™×.";
      if (winners.length) {
        const names = winners.map((id) =>
          (teams[id] && teams[id].name) || "×§×‘×•×¦×” " + id
        );
        if (names.length === 1) {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×!\n×”×× ×¦×—×™×: " + names[0] + " ğŸ‰";
        } else {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×!\n×ª×™×§×• ×‘×™×Ÿ: " + names.join(", ");
        }
      }
      alert(msg);

      // ×œ× ×× ×§×™× ××•×˜×•××˜×™×ª ××ª ×”-localStorage â€“ × ×•×ª× ×™× ×œ×©×—×§×Ÿ ×œ×‘×—×•×¨ ×× ×œ×¦××ª
      roundInfoEl.textContent = "×”××©×—×§ ×”×¡×ª×™×™×. ××¤×©×¨ ×œ×¦××ª ×•×œ×”×¦×˜×¨×£ ×œ××©×—×§ ×—×“×©.";
      roleInfoEl.textContent = "";
      stopLocalRoundTimer();
      isExplainer = false;
      wordBox.classList.add("hidden");
      explainerButtons.classList.add("hidden");
    });

    // × ×™×¡×™×•×Ÿ ×”×ª×—×‘×¨×•×ª ××•×˜×•××˜×™ ×œ×¤×™ ××¦×‘ ×©××•×¨
    (function autoReconnect() {
      let saved = null;
      try {
        saved = JSON.parse(localStorage.getItem("cohens_player") || "null");
      } catch (e) {
        saved = null;
      }
      if (!saved || !saved.gameCode || !saved.playerName || !saved.teamId) {
        return;
      }

      playerNameInput.value = saved.playerName;
      gameCodeInput.value = saved.gameCode;
      teamSelect.value = saved.teamId;

      currentClientId = saved.clientId || null;
      currentTeamId = saved.teamId;

      joinStatus.textContent = "××ª×—×‘×¨ ×—×–×¨×” ×œ××©×—×§ ×§×•×“×...";

      socket.emit(
        "joinGame",
        {
          gameCode: saved.gameCode,
          playerName: saved.playerName,
          teamId: saved.teamId,
          clientId: saved.clientId || undefined,
        },
        (res) => {
          if (!res || !res.ok) {
            joinStatus.textContent = "×”××©×—×§ ×”×§×•×“× ×›×‘×¨ ×œ× ×¤×¢×™×œ. ×ª×•×›×œ ×œ×”×¦×˜×¨×£ ×œ××©×—×§ ×—×“×©.";
            clearPlayerState();
            return;
          }
          currentGameCode = res.gameCode;
          currentClientId = res.clientId;
          currentGameState = res.game || null;

          myNameLabel.textContent = saved.playerName;
          const team =
            currentGameState &&
            currentGameState.teams &&
            currentGameState.teams[saved.teamId];
          myTeamLabel.textContent = team
            ? team.name || ("×§×‘×•×¦×” " + saved.teamId)
            : "×§×‘×•×¦×” " + saved.teamId;

          renderScoreboard(currentGameState ? currentGameState.teams : null);
          switchToGameUI();
          joinStatus.textContent = "";
        }
      );
    })();

    // ××™×ª×•×’ ×œ××¡×š ×©×—×§×Ÿ â€“ ×œ×•×’×• + ×‘×× ×¨
    (function loadBrandingForPlayer() {
      fetch("/api/banners")
        .then((res) => res.json())
        .then((data) => {
          if (!data) return;

          const logoCfg = data.logo;
          if (logoCfg && logoCfg.imageUrl && playerLogoEl) {
            playerLogoEl.src = logoCfg.imageUrl;
            playerLogoEl.alt = logoCfg.altText || "×›×”× '×¡";
            playerLogoEl.classList.remove("hidden");
          }

          if (!playerBannerSlot) return;
          const cfg = data.player;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.className = "ad-banner";
          a.href = cfg.linkUrl;
          a.target = "_blank";
          a.rel = "noopener";

          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.alt = "Banner";

          a.appendChild(img);
          playerBannerSlot.appendChild(a);
        })
        .catch(() => {});
    })();
  </script>
</body>
</html>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .app {
      max-width: 480px;
      width: 100%;
      padding: 20px 16px 40px;
    }
    .card {
      background: #020617;
      border-radius: 18px;
      padding: 16px 16px 18px;
      box-shadow: 0 14px 35px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 16px;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-bottom: 2px;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #020617;
      box-shadow: 0 10px 25px rgba(56,189,248,0.35);
      width: 100%;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(56,189,248,0.5);
    }
    .btn-success {
      background: #22c55e;
      color: #022c22;
      flex: 1;
    }
    .btn-warning {
      background: #fbbf24;
      color: #451a03;
      flex: 1;
    }
    .btn-exit {
      background: transparent;
      border: 1px solid #f97373;
      color: #fecaca;
      width: 100%;
      margin-top: 10px;
    }
    .btn-exit:hover {
      background: rgba(248,113,113,0.18);
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      width: 100%;
      margin-top: 8px;
    }
    .btn-secondary:hover {
      background: rgba(15,23,42,0.8);
    }
    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .hidden {
      display: none !important;
    }
    .status-text {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .big-word {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 8px 0 12px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.75rem;
      color: #9ca3af;
      gap: 6px;
    }
    .score-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.9rem;
    }
    .score-val {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .score-me {
      color: #22c55e;
    }
    .ad-banner {
      display: block;
      margin-top: 8px;
      border-radius: 18px;
      padding: 4px;
      background: radial-gradient(circle at top left, rgba(34,197,94,0.22), rgba(15,23,42,0.98));
      border: 1px solid rgba(74,222,128,0.55);
      text-decoration: none;
    }
    .ad-banner img {
      width: 100%;
      display: block;
      border-radius: 14px;
    }
    /* ×œ×•×’×• ×§×˜×Ÿ */
    .logo-small {
      height: 28px;
      width: auto;
      border-radius: 10px;
      object-fit: contain;
    }
    /* Popup ×¡×•×£ ×¡×™×‘×•×‘ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #020617;
      border-radius: 18px;
      padding: 16px 18px 18px;
      border: 1px solid rgba(148,163,184,0.65);
      max-width: 320px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×¨×˜×™×¡ ×”×¦×˜×¨×¤×•×ª -->
    <div class="card" id="join-card">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <img id="player-logo-join" class="logo-small hidden" alt="×›×”× '×¡ ×œ×•×’×•" />
        <h2 style="margin:0;">×›×”× '×¡ - ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§</h2>
      </div>
      <p style="margin:0 0 10px; font-size:0.85rem; color:#9ca3af;">
        ×§×‘×œ×• ××”×× ×”×œ ×§×•×“ ××©×—×§, ×‘×—×¨×• ×©× ×•×§×‘×•×¦×”, ×•×”×¦×˜×¨×¤×•.
      </p>
      <div style="margin-bottom:10px;">
        <label for="joinCode">×§×•×“ ××©×—×§</label>
        <input id="joinCode" type="text" placeholder="×œ×“×•×’××”: AB4F" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="playerName">×”×©× ×©×œ×š</label>
        <input id="playerName" type="text" placeholder="×œ×“×•×’××”: ××©×”" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="teamId">×œ××™×–×• ×§×‘×•×¦×” ××ª×” ××¦×˜×¨×£?</label>
        <select id="teamId">
          <option value="A">×§×‘×•×¦×” 1 (A)</option>
          <option value="B">×§×‘×•×¦×” 2 (B)</option>
          <option value="C">×§×‘×•×¦×” 3 (C)</option>
          <option value="D">×§×‘×•×¦×” 4 (D)</option>
          <option value="E">×§×‘×•×¦×” 5 (E)</option>
        </select>
      </div>
      <button id="joinBtn" class="btn btn-primary">×”×¦×˜×¨×£ ×œ××©×—×§</button>
      <button id="backHomeBtn" class="btn btn-secondary">â¬… ×—×–×¨×” ×œ××¡×š ×”×‘×™×ª</button>
      <p id="joinError" class="status-text" style="color:#f97373; margin-top:8px;"></p>
    </div>

    <!-- ×›×¨×˜×™×¡ ×©×—×§×Ÿ ×œ××—×¨ ×”×¦×˜×¨×¤×•×ª -->
    <div class="card hidden" id="player-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <img id="player-logo-main" class="logo-small hidden" alt="×›×”× '×¡ ×œ×•×’×•" />
          <h3 style="margin:0; font-size:1.1rem;">×›×”× '×¡ - ××©×—×§ ×¤×¢×™×œ</h3>
        </div>
        <span class="tag">
          <span id="tagGameCode">×§×•×“: ----</span>
        </span>
      </div>
      <div class="status-text" id="playerInfo">
        ××—×›×” ×œ×”×ª×—×œ×ª ×”××©×—×§...
      </div>
      <button id="leaveBtn" class="btn btn-exit">ğŸšª ×™×¦×™××” ××”××©×—×§</button>
    </div>

    <!-- ×›×¨×˜×™×¡ ×œ××¡×‘×™×¨ -->
    <div class="card hidden" id="explainer-card">
      <div class="tag" style="margin-bottom:6px;">
        ××ª×” ×”××¡×‘×™×¨ ×‘×¡×™×‘×•×‘ ×”×–×”
      </div>
      <div class="big-word" id="currentWord">××™×œ×” ×ª×•×¤×™×¢ ×›××Ÿ</div>
      <div class="status-text" id="explainerHint">
        ××¡×•×¨ ×œ×•××¨ ××ª ×”××™×œ×” ×¢×¦××”, ×—×œ×§×™× ××× ×” ××• ×œ×ª×¨×’× â€“ ×¨×§ ×œ×ª××¨ ×‘×¨××–×™×.
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button id="correctBtn" class="btn btn-success">âœ… × ×›×•×Ÿ</button>
        <button id="skipBtn" class="btn btn-warning">â­ ×“×™×œ×•×’</button>
      </div>
    </div>

    <!-- ×¡×˜×˜×•×¡ ×¡×™×‘×•×‘ + ×˜×™×™××¨ -->
    <div class="card hidden" id="round-status-card">
      <h3 style="margin:0 0 8px; font-size:1rem;">××¦×‘ ×¡×™×‘×•×‘</h3>
      <div class="status-text" id="roundStatus">××—×›×™× ×œ×”×ª×—×œ×ª ×¡×™×‘×•×‘...</div>
      <div class="status-text" id="roundTimerText" style="margin-top:4px;">×–××Ÿ × ×•×ª×¨: --:--</div>
    </div>

    <!-- × ×™×§×•×“ + ×‘×× ×¨ -->
    <div class="card hidden" id="score-card">
      <h3 style="margin:0 0 8px; font-size:1rem;">× ×™×§×•×“</h3>
      <div id="scoreboardDynamic"></div>
      <div class="status-text" id="scoreTarget" style="margin-top:6px;"></div>

      <div id="player-banner-slot"></div>
    </div>
  </div>

  <!-- Popup ×¡×•×£ ×¡×™×‘×•×‘ -->
  <div id="roundPopup" class="modal-backdrop hidden">
    <div class="modal">
      <h3 id="roundPopupTitle" style="margin:0 0 8px;">×¡×™×•× ×¡×™×‘×•×‘</h3>
      <p id="roundPopupText" style="font-size:0.9rem; margin:8px 0 16px;"></p>
      <button id="roundPopupClose" class="btn btn-primary">×¡×’×•×¨</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const STORAGE_KEY = "cohens-player-state";

    let mySocketId = null;
    let joinedGameCode = null;
    let myName = null;
    let myTeamId = null;
    let isExplainer = false;
    let lastGameState = null;
    let clientId = null;
    let savedStateForAutoJoin = null;
    let hasJoined = false;

    let roundTimeLeft = 0;
    let roundTimerId = null;

    const joinCard = document.getElementById("join-card");
    const joinCodeInput = document.getElementById("joinCode");
    const playerNameInput = document.getElementById("playerName");
    const teamIdSelect = document.getElementById("teamId");
    const joinBtn = document.getElementById("joinBtn");
    const backHomeBtn = document.getElementById("backHomeBtn");
    const joinError = document.getElementById("joinError");

    const playerCard = document.getElementById("player-card");
    const tagGameCode = document.getElementById("tagGameCode");
    const playerInfo = document.getElementById("playerInfo");
    const leaveBtn = document.getElementById("leaveBtn");

    const explainerCard = document.getElementById("explainer-card");
    const currentWordEl = document.getElementById("currentWord");
    const explainerHint = document.getElementById("explainerHint");
    const correctBtn = document.getElementById("correctBtn");
    const skipBtn = document.getElementById("skipBtn");

    const roundStatusCard = document.getElementById("round-status-card");
    const roundStatus = document.getElementById("roundStatus");
    const roundTimerText = document.getElementById("roundTimerText");

    const scoreCard = document.getElementById("score-card");
    const scoreboardDynamic = document.getElementById("scoreboardDynamic");
    const scoreTarget = document.getElementById("scoreTarget");

    const popupEl = document.getElementById("roundPopup");
    const popupTitleEl = document.getElementById("roundPopupTitle");
    const popupTextEl = document.getElementById("roundPopupText");
    const popupCloseBtn = document.getElementById("roundPopupClose");

    const logoJoin = document.getElementById("player-logo-join");
    const logoMain = document.getElementById("player-logo-main");

    (function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const saved = JSON.parse(raw);
          if (saved) {
            savedStateForAutoJoin = saved;
            if (saved.clientId) clientId = saved.clientId;
            if (saved.gameCode) joinCodeInput.value = saved.gameCode;
            if (saved.playerName) playerNameInput.value = saved.playerName;
            if (saved.teamId) teamIdSelect.value = saved.teamId;
          }
        }
      } catch (e) {}
      if (!clientId) {
        clientId = "c-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      }
    })();

    socket.on("connect", () => {
      mySocketId = socket.id;
      if (
        !hasJoined &&
        savedStateForAutoJoin &&
        savedStateForAutoJoin.gameCode &&
        savedStateForAutoJoin.playerName &&
        savedStateForAutoJoin.teamId
      ) {
        autoRejoin(savedStateForAutoJoin);
      }
    });

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, "0");
      const s = (seconds % 60).toString().padStart(2, "0");
      return m + ":" + s;
    }

    function updateRoundTimerUI() {
      if (!roundTimerText) return;
      roundTimerText.textContent = "×–××Ÿ × ×•×ª×¨: " + formatTime(roundTimeLeft);
    }

    function startRoundTimer(durationSeconds) {
      clearInterval(roundTimerId);
      roundTimeLeft = durationSeconds;
      updateRoundTimerUI();
      roundTimerId = setInterval(() => {
        roundTimeLeft--;
        if (roundTimeLeft <= 0) {
          roundTimeLeft = 0;
          clearInterval(roundTimerId);
          updateRoundTimerUI();
        } else {
          updateRoundTimerUI();
        }
      }, 1000);
    }

    function saveStateToStorage() {
      try {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({
            gameCode: joinedGameCode,
            playerName: myName,
            teamId: myTeamId,
            clientId
          })
        );
      } catch (e) {}
    }

    function clearStateAndReload() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
      hasJoined = false;
      joinedGameCode = null;
      myName = null;
      myTeamId = null;
      lastGameState = null;
      isExplainer = false;
      savedStateForAutoJoin = null;
      window.location.href = "/player.html";
    }

    function updatePlayerInfo() {
      if (!myName || !myTeamId || !lastGameState || !lastGameState.teams) {
        playerInfo.textContent = "××—×•×‘×¨ ×›-" + (myName || "×©×—×§×Ÿ") + ".";
        return;
      }
      const team = lastGameState.teams[myTeamId];
      const teamName = team ? team.name || ("×§×‘×•×¦×” " + myTeamId) : ("×§×‘×•×¦×” " + myTeamId);
      playerInfo.textContent = "××—×•×‘×¨ ×›-" + myName + " ×‘×§×‘×•×¦×” " + teamName + " (" + myTeamId + ").";
    }

    function renderScoresFromGame(game) {
      if (!game || !game.teams) return;
      lastGameState = game;

      const teams = game.teams;
      scoreboardDynamic.innerHTML = "";

      const ids = Object.keys(teams);
      ids.forEach(id => {
        const t = teams[id];
        const score = t.score || 0;

        const row = document.createElement("div");
        row.className = "score-row";

        const left = document.createElement("span");
        left.textContent = t.name || ("×§×‘×•×¦×” " + id);

        const right = document.createElement("span");
        right.className = "score-val";
        if (myTeamId === id) {
          right.classList.add("score-me");
        }
        right.textContent = score;

        row.appendChild(left);
        row.appendChild(right);
        scoreboardDynamic.appendChild(row);
      });

      if (game.targetScore) {
        scoreTarget.textContent = "××©×—×§ ×œ-" + game.targetScore + " × ×§×•×“×•×ª.";
      } else {
        scoreTarget.textContent = "";
      }

      updatePlayerInfo();
    }

    function onJoinSuccess(res, code, name, teamId) {
      hasJoined = true;
      joinedGameCode = res.gameCode;
      myName = name;
      myTeamId = teamId;
      lastGameState = res.game;
      if (res.clientId) {
        clientId = res.clientId;
      }

      saveStateToStorage();

      joinCard.classList.add("hidden");
      playerCard.classList.remove("hidden");
      roundStatusCard.classList.remove("hidden");
      scoreCard.classList.remove("hidden");

      tagGameCode.textContent = "×§×•×“: " + joinedGameCode;
      renderScoresFromGame(res.game);
      updatePlayerInfo();
    }

    function autoRejoin(saved) {
      const code = (saved.gameCode || "").trim().toUpperCase();
      const name = (saved.playerName || "").trim();
      const team = (saved.teamId || "A").toUpperCase();

      if (!code || !name) return;

      socket.emit(
        "joinGame",
        {
          gameCode: code,
          playerName: name,
          teamId: team,
          clientId
        },
        (res) => {
          if (!res || !res.ok) {
            try {
              localStorage.removeItem(STORAGE_KEY);
            } catch (e) {}
            return;
          }
          onJoinSuccess(res, code, name, team);
        }
      );
    }

    joinBtn.addEventListener("click", () => {
      joinError.textContent = "";
      const code = (joinCodeInput.value || "").trim().toUpperCase();
      const name = (playerNameInput.value || "").trim();
      const teamId = (teamIdSelect.value || "A").toUpperCase();

      if (!code) {
        joinError.textContent = "×¦×¨×™×š ×œ×”×–×™×Ÿ ×§×•×“ ××©×—×§.";
        return;
      }
      if (!name) {
        joinError.textContent = "×¦×¨×™×š ×œ×”×–×™×Ÿ ×©×.";
        return;
      }

      socket.emit(
        "joinGame",
        {
          gameCode: code,
          playerName: name,
          teamId,
          clientId
        },
        (res) => {
          if (!res || !res.ok) {
            joinError.textContent =
              (res && res.error) ? res.error : "×œ× ×”×¦×œ×—× ×• ×œ×”×¦×˜×¨×£ ×œ××©×—×§.";
            return;
          }
          onJoinSuccess(res, code, name, teamId);
        }
      );
    });

    if (backHomeBtn) {
      backHomeBtn.addEventListener("click", () => {
        window.location.href = "/";
      });
    }

    function ensureLastGameStateFromPayload(payload) {
      if (!lastGameState) {
        lastGameState = {};
      }
      if (payload.teams) {
        lastGameState.teams = payload.teams;
      }
      if (payload.scores && lastGameState.teams) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (!lastGameState.teams[id]) {
            lastGameState.teams[id] = { id, name: "×§×‘×•×¦×” " + id, score: 0 };
          }
          lastGameState.teams[id].score = s;
        });
      }
      if (payload.targetScore) {
        lastGameState.targetScore = payload.targetScore;
      }
    }

    socket.on("gameUpdated", (game) => {
      if (!joinedGameCode || !game || game.code !== joinedGameCode) return;
      renderScoresFromGame(game);
    });

    function showRoundPopup(roundScore, teamName) {
      if (!popupEl) return;
      const score = typeof roundScore === "number" ? roundScore : 0;
      let msg;
      if (score < 5) {
        msg = "××ª× ×—×œ×©×™×";
      } else if (score <= 10) {
        msg = "×¦×•×•×ª × ×—××“ ×”×™×™×ª×™ ××•××¨";
      } else {
        msg = "××ª× ×—×–×§×™× ×‘××™×œ×™× ××”? ××§×•×•×” ×©×’× ×‘××¢×©×™×";
      }
      popupTitleEl.textContent = "×¡×™×•× ×¡×™×‘×•×‘ - " + (teamName || "");
      popupTextEl.textContent = msg + " (" + score + " × ×§×•×“×•×ª ×‘×¡×™×‘×•×‘ ×”×–×”)";
      popupEl.classList.remove("hidden");
    }

    popupCloseBtn.addEventListener("click", () => {
      popupEl.classList.add("hidden");
    });

    socket.on("roundStarted", (payload) => {
      if (!joinedGameCode || !payload) return;

      ensureLastGameStateFromPayload(payload);
      renderScoresFromGame(lastGameState);

      const isMyTeamTurn = (myTeamId === payload.teamId);
      isExplainer = (clientId && clientId === payload.explainerId);

      let txt = "×¡×™×‘×•×‘ ×”×ª×—×™×œ ×œ×§×‘×•×¦×” " +
        (lastGameState.teams?.[payload.teamId]?.name || payload.teamId) + ".";
      if (isMyTeamTurn) {
        txt += " ×–×” ×”×ª×•×¨ ×©×œ ×”×§×‘×•×¦×” ×©×œ×š.";
      } else {
        txt += " ×›×¨×’×¢ ×–×• ×§×‘×•×¦×” ××—×¨×ª.";
      }
      roundStatus.textContent = txt;

      startRoundTimer(payload.roundTime || 60);

      if (isExplainer) {
        explainerCard.classList.remove("hidden");
        currentWordEl.textContent = "××™×œ×” × ×˜×¢× ×ª...";
        explainerHint.textContent =
          "××ª×” ×”××¡×‘×™×¨! ×”××ª×Ÿ ×œ××™×œ×” ×•×”×ª×—×œ ×œ×ª××¨ ×‘×œ×™ ×œ×•××¨ ××•×ª×”.";
      } else {
        explainerCard.classList.add("hidden");
      }
    });

    socket.on("wordForExplainer", (data) => {
      if (!isExplainer) return;
      if (!data || !data.word) return;
      currentWordEl.textContent = data.word;
    });

    socket.on("scoreUpdated", (payload) => {
      if (!payload) return;
      ensureLastGameStateFromPayload(payload);
      renderScoresFromGame(lastGameState);
    });

    socket.on("roundEnded", (payload) => {
      clearInterval(roundTimerId);
      roundTimeLeft = 0;
      updateRoundTimerUI();

      let txt = "×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×.";
      let teamName = "";
      if (payload && payload.teamId && lastGameState && lastGameState.teams) {
        teamName = lastGameState.teams[payload.teamId]?.name || payload.teamId;
        txt = "×”×¡×™×‘×•×‘ ×©×œ " + teamName + " ×”×¡×ª×™×™×.";
      }
      roundStatus.textContent = txt;
      isExplainer = false;
      explainerCard.classList.add("hidden");

      if (payload && payload.scores) {
        ensureLastGameStateFromPayload(payload);
        renderScoresFromGame(lastGameState);
      }

      const rs = payload && typeof payload.roundScore === "number" ? payload.roundScore : 0;
      showRoundPopup(rs, teamName);
    });

    socket.on("gameEnded", (payload) => {
      if (!payload) return;

      clearInterval(roundTimerId);
      roundTimeLeft = 0;
      updateRoundTimerUI();

      if (!lastGameState) lastGameState = {};
      if (payload.teams) {
        lastGameState.teams = payload.teams;
      }
      if (payload.scores && lastGameState.teams) {
        Object.entries(payload.scores).forEach(([id, s]) => {
          if (!lastGameState.teams[id]) {
            lastGameState.teams[id] = { id, name: "×§×‘×•×¦×” " + id, score: 0 };
          }
          lastGameState.teams[id].score = s;
        });
      }
      renderScoresFromGame(lastGameState);

      let msg = "×”××©×—×§ ×”×¡×ª×™×™×.";
      if (payload.teams && payload.winnerTeamIds && payload.winnerTeamIds.length) {
        const names = payload.winnerTeamIds
          .map(id => payload.teams[id]?.name || ("×§×‘×•×¦×” " + id));
        if (names.length === 1) {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×! ×›×œ ×”×›×‘×•×“ ×œ-" + names[0] + " ğŸš€";
        } else {
          msg = "×”××©×—×§ ×”×¡×ª×™×™×! ×ª×™×§×• ×‘×™×Ÿ: " + names.join(", ");
        }
      }
      roundStatus.textContent = msg;
      isExplainer = false;
      explainerCard.classList.add("hidden");

      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    });

    correctBtn.addEventListener("click", () => {
      if (!isExplainer || !joinedGameCode) return;
      socket.emit("markCorrect", { gameCode: joinedGameCode });
    });

    skipBtn.addEventListener("click", () => {
      if (!isExplainer || !joinedGameCode) return;
      socket.emit("skipWord", { gameCode: joinedGameCode });
    });

    // ×›×¤×ª×•×¨ ×™×¦×™××” ××”××©×—×§
    leaveBtn.addEventListener("click", () => {
      const ok = confirm("×œ×¦××ª ××”××©×—×§? ×ª×•×›×œ ×œ×”×¦×˜×¨×£ ×©×•×‘ ×¢× ×§×•×“ ×—×“×©.");
      if (!ok) return;
      if (joinedGameCode && clientId) {
        socket.emit("leaveGame", { gameCode: joinedGameCode, clientId });
      }
      clearStateAndReload();
    });

    // ×˜×¢×™× ×ª ×œ×•×’×• + ×‘×× ×¨ ×œ×©×—×§×Ÿ
    (function loadPlayerBranding() {
      const slot = document.getElementById("player-banner-slot");
      fetch("/api/banners")
        .then(res => res.json())
        .then(data => {
          if (!data) return;

          // ×œ×•×’×•
          const logoCfg = data.logo;
          if (logoCfg && logoCfg.imageUrl) {
            [logoJoin, logoMain].forEach(el => {
              if (!el) return;
              el.src = logoCfg.imageUrl;
              el.alt = logoCfg.altText || "×›×”× '×¡";
              el.classList.remove("hidden");
            });
          }

          // ×‘×× ×¨ ×©×—×§×Ÿ
          if (!slot) return;
          const cfg = data.player;
          if (!cfg || !cfg.imageUrl || !cfg.linkUrl) return;

          const a = document.createElement("a");
          a.className = "ad-banner";
          a.href = cfg.linkUrl;
          a.target = "_blank";
          a.rel = "noopener";

          const img = document.createElement("img");
          img.src = cfg.imageUrl;
          img.alt = "Banner";

          a.appendChild(img);
          slot.appendChild(a);
        })
        .catch(() => {});
    })();
  </script>
</body>
</html>
